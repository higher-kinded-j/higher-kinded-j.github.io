<!DOCTYPE HTML>
<html lang="en" class="latte sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Stack Archetypes - Higher-Kinded-J: Composable Effects and Advanced Optics for Java</title>


        <!-- Custom HTML head -->


            <meta name="description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">


        <meta name="keywords" content="Higher-Kinded Types, Higher-Kinded-J, HKT, Java, Optics, Lens, Prism, Traversal, Iso, Affine, Focus DSL, Effect Path API, Functional Programming, Monad, Functor, Applicative, EitherPath, MaybePath, TryPath, ValidationPath, Java Records, Sealed Interface, Error Handling, Immutable Data">
        
        <meta property="og:title" content="Stack Archetypes - Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
            <meta property="og:description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://higher-kinded-j.github.io/">
        <meta property="og:image" content="https://higher-kinded-j.github.io/preview.png">
        <meta property="og:image:width" content="1200">
        <meta property="og:image:height" content="630">
        <meta property="og:site_name" content="Higher-Kinded-J Documentation">
        <meta property="og:locale" content="en_GB">
        
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="Stack Archetypes - Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
        <meta name="twitter:description" content="Unifying Composable Effects and Advanced Optics for Java. Effect Path API, Focus DSL, and the most comprehensive optics implementation in the Java ecosystem.">
        <meta name="twitter:image" content="https://higher-kinded-j.github.io/preview.png">
        <meta name="twitter:image:alt" content="Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
        <meta name="description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">
        <meta name="google-site-verification" content="X-xsiAq2cKMLOzh9dexUrX8Onx2h_YMUFgp5lHHUwSg" />
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin.css">
        <link rel="stylesheet" href=".././theme/catppuccin-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin-alerts.css">
        <link rel="stylesheet" href=".././theme/additional-hkj.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "latte";
            const default_dark_theme = "macchiato";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('latte')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frappé</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        <div class="version-selector-container">
                            <select id="version-selector" class="version-selector" aria-label="Select documentation version" title="Select documentation version">
                                <option value="">Loading versions...</option>
                            </select>
                        </div>
                    </div>

                    <h1 class="menu-title">Higher-Kinded-J: Composable Effects and Advanced Optics for Java</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j/edit/main/hkj-book/src/transformers/archetypes.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="stack-archetypes-named-patterns-for-common-problems"><a class="header" href="#stack-archetypes-named-patterns-for-common-problems">Stack Archetypes: Named Patterns for Common Problems</a></h1>
<p>Every enterprise application juggles multiple concerns: typed errors, optional lookups, validation, shared context, audit trails, stateful workflows, and safe recursion. Rather than designing a composition strategy from scratch each time, these <strong>named archetypes</strong> give you a ready-made pattern for the most common situations.</p>
<div id="admonition-what-youll-learn" class="admonition admonish-info" role="note" aria-labelledby="admonition-what-youll-learn-title">
<div class="admonition-title">
<div id="admonition-what-youll-learn-title">
<p>What You'll Learn</p>
</div>
<a class="admonition-anchor-link" href="#admonition-what-youll-learn"></a>
</div>
<div>
<ul>
<li>Seven named stack archetypes that cover the vast majority of enterprise use cases</li>
<li>Which Path type to reach for when you recognise a familiar problem</li>
<li>How each archetype maps to its underlying monad transformer (for when you need the raw machinery)</li>
<li>How archetypes compose together in real-world workflows</li>
</ul>
</div>
</div>
<div id="admonition-see-example-code" class="admonition admonish-example" role="note" aria-labelledby="admonition-see-example-code-title">
<div class="admonition-title">
<div id="admonition-see-example-code-title">
<p>See Example Code</p>
</div>
<a class="admonition-anchor-link" href="#admonition-see-example-code"></a>
</div>
<div>
<p><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/effect/ArchetypeExamples.java">ArchetypeExamples.java</a></p>
</div>
</div>
<hr />
<h2 id="archetypes-at-a-glance"><a class="header" href="#archetypes-at-a-glance">Archetypes at a Glance</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Archetype</th><th>Path Type</th><th>Underlying Type</th><th>Enterprise Use Case</th></tr></thead><tbody>
<tr><td><a href="#the-service-stack">Service Stack</a></td><td><code>EitherPath&lt;E, A&gt;</code></td><td><code>Either&lt;E, A&gt;</code></td><td>Typed domain errors with short-circuit</td></tr>
<tr><td><a href="#the-lookup-stack">Lookup Stack</a></td><td><code>MaybePath&lt;A&gt;</code></td><td><code>Maybe&lt;A&gt;</code></td><td>Optional lookups with fallback chains</td></tr>
<tr><td><a href="#the-validation-stack">Validation Stack</a></td><td><code>ValidationPath&lt;E, A&gt;</code></td><td><code>Validated&lt;E, A&gt;</code></td><td>Collecting all errors, not just the first</td></tr>
<tr><td><a href="#the-context-stack">Context Stack</a></td><td><code>ReaderPath&lt;R, A&gt;</code></td><td><code>Reader&lt;R, A&gt;</code></td><td>Dependency injection; multi-tenant context</td></tr>
<tr><td><a href="#the-audit-stack">Audit Stack</a></td><td><code>WriterPath&lt;W, A&gt;</code></td><td><code>Writer&lt;W, A&gt;</code></td><td>Compliance audit trails; structured logging</td></tr>
<tr><td><a href="#the-workflow-stack">Workflow Stack</a></td><td><code>WithStatePath&lt;S, A&gt;</code></td><td><code>State&lt;S, A&gt;</code></td><td>State machine transitions; stateful pipelines</td></tr>
<tr><td><a href="#the-safe-recursion-stack">Safe Recursion Stack</a></td><td><code>TrampolinePath&lt;A&gt;</code></td><td><code>Trampoline&lt;A&gt;</code></td><td>Stack-safe recursion; paginated aggregation</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="the-service-stack"><a class="header" href="#the-service-stack">The Service Stack</a></h2>
<p><strong>Path type:</strong> <code>EitherPath&lt;E, A&gt;</code>
<strong>Underlying type:</strong> <code>Either&lt;E, A&gt;</code>
<strong>Raw transformer:</strong> <code>EitherT&lt;F, E, A&gt;</code></p>
<h3 id="the-problem"><a class="header" href="#the-problem">The problem</a></h3>
<p>Your service method can fail in multiple, domain-specific ways: insufficient funds, account suspended, gateway timeout. Traditional Java forces a choice between checked exceptions (verbose, uncompilable in lambdas) and unchecked exceptions (invisible, unsafe). Neither option composes cleanly across a multi-step pipeline.</p>
<pre style="line-height:1.5;font-size:0.95em">
    <span style="color:#4CAF50"><b>Success</b> ═══●══════════●══════════●══════════●═══▶  Confirmation</span>
    <span style="color:#4CAF50">          right      via        via       map</span>
    <span style="color:#4CAF50">        (account)  (validate)  (charge)</span>
                        ╲            ╲
                         ╲            ╲  error: switch tracks
                          ╲            ╲
    <span style="color:#F44336"><b>Failure</b> ────────────●────────────●──────────────▶  PaymentError</span>
    <span style="color:#F44336">              InsufficientFunds  GatewayTimeout</span>
                                        │
                                   <span style="color:#4CAF50">recoverWith</span>    circuit-breaker: retry once
                                        │
    <span style="color:#4CAF50">                                    ●═══▶  retried Confirmation</span>
</pre>
<h3 id="the-solution"><a class="header" href="#the-solution">The solution</a></h3>
<pre><code class="language-java">// Domain error hierarchy
sealed interface PaymentError {
    record InsufficientFunds(String accountId, double shortfall) implements PaymentError {}
    record AccountNotFound(String accountId) implements PaymentError {}
    record AccountSuspended(String accountId) implements PaymentError {}
    record GatewayTimeout(String provider) implements PaymentError {}
}

// Service method returning a typed error channel
EitherPath&lt;PaymentError, PaymentConfirmation&gt; processPayment(PaymentRequest request) {
    return Path.&lt;PaymentError, Account&gt;right(lookupAccount(request.accountId()))
        .via(account -&gt; validateBalance(account, request.amount()))
        .via(account -&gt; chargeAccount(account, request.amount()))
        .map(charge -&gt; new PaymentConfirmation(charge.transactionId()));
}

// Circuit-breaker with retry: recover from transient failures
EitherPath&lt;PaymentError, PaymentConfirmation&gt; resilientPayment(PaymentRequest request) {
    return processPayment(request)
        .recoverWith(error -&gt; switch (error) {
            case PaymentError.GatewayTimeout t -&gt; processPayment(request);  // retry once
            default -&gt; Path.left(error);                                    // propagate
        });
}
</code></pre>
<h3 id="when-to-use"><a class="header" href="#when-to-use">When to use</a></h3>
<p>This is the default archetype. Most service-layer methods that can fail with domain-specific errors should start here. The typed error channel makes every failure mode visible in the method signature, and <code>recoverWith</code> gives you a natural place for circuit-breaker and retry logic.</p>
<h3 id="the-imperative-alternative"><a class="header" href="#the-imperative-alternative">The imperative alternative</a></h3>
<pre><code class="language-java">// Without EitherPath: scattered try/catch, invisible error modes
try {
    Account account = lookupAccount(request.accountId());
    if (account.balance() &lt; request.amount()) {
        throw new InsufficientFundsException(account.id(), ...);
    }
    Charge charge = chargeAccount(account, request.amount());
    return new PaymentConfirmation(charge.transactionId());
} catch (GatewayTimeoutException e) {
    // Retry logic mixed with business logic
    return processPayment(request);  // but what about the other exceptions?
}
</code></pre>
<hr />
<h2 id="the-lookup-stack"><a class="header" href="#the-lookup-stack">The Lookup Stack</a></h2>
<p><strong>Path type:</strong> <code>MaybePath&lt;A&gt;</code>
<strong>Underlying type:</strong> <code>Maybe&lt;A&gt;</code>
<strong>Raw transformer:</strong> <code>MaybeT&lt;F, A&gt;</code></p>
<h3 id="the-problem-1"><a class="header" href="#the-problem-1">The problem</a></h3>
<p>You need to resolve a value from multiple sources with a defined priority: first check the database, then the environment, then fall back to defaults. Each source might return nothing. With <code>Optional</code>, you end up with nested <code>flatMap</code> chains that obscure the fallback logic.</p>
<pre style="line-height:1.5;font-size:0.95em">
    <span style="color:#4CAF50"><b>Present</b>  ═══●═══════════════════════════════════════▶  Config</span>
    <span style="color:#4CAF50">         database</span>
                ╲
                 ╲  nothing: try next source
                  ╲
    <span style="color:#F44336"><b>Absent</b></span>   ──────●
                  │ <span style="color:#4CAF50">orElse</span>
    <span style="color:#4CAF50"><b>Present</b>  ═════●═════════════════════════════════════▶  Config</span>
    <span style="color:#4CAF50">         environment</span>
                  ╲
                   ╲  nothing: try next source
                    ╲
    <span style="color:#F44336"><b>Absent</b></span>   ────────●
                    │ <span style="color:#4CAF50">orElse</span>
    <span style="color:#4CAF50"><b>Present</b>  ═══════●═══════════════════════════════════▶  Config</span>
    <span style="color:#4CAF50">          defaults (guaranteed)</span>
</pre>
<h3 id="the-solution-1"><a class="header" href="#the-solution-1">The solution</a></h3>
<pre><code class="language-java">MaybePath&lt;Config&gt; resolveConfig(String key) {
    return lookupFromDatabase(key)                          // MaybePath&lt;Config&gt;
        .orElse(() -&gt; lookupFromEnvironment(key))           // try next source
        .orElse(() -&gt; Path.just(Config.defaultFor(key)));   // guaranteed fallback
}

// Each lookup returns MaybePath
MaybePath&lt;Config&gt; lookupFromDatabase(String key) {
    return Path.maybe(database.find(key));   // Nothing if absent
}
</code></pre>
<h3 id="when-to-use-1"><a class="header" href="#when-to-use-1">When to use</a></h3>
<p>Whenever absence is normal and expected, not an error. Cache lookups, configuration resolution, optional user preferences, feature flag checks. If the caller needs to know <em>why</em> the value is missing, use the Service Stack instead.</p>
<h3 id="the-imperative-alternative-1"><a class="header" href="#the-imperative-alternative-1">The imperative alternative</a></h3>
<pre><code class="language-java">// Without MaybePath: null-check chains
Config config = database.find(key);
if (config == null) {
    config = System.getenv(key) != null ? Config.parse(System.getenv(key)) : null;
}
if (config == null) {
    config = Config.defaultFor(key);
}
</code></pre>
<hr />
<h2 id="the-validation-stack"><a class="header" href="#the-validation-stack">The Validation Stack</a></h2>
<p><strong>Path type:</strong> <code>ValidationPath&lt;E, A&gt;</code>
<strong>Underlying type:</strong> <code>Validated&lt;E, A&gt;</code>
<strong>No direct transformer equivalent</strong></p>
<h3 id="the-problem-2"><a class="header" href="#the-problem-2">The problem</a></h3>
<p>A REST API receives a request body with multiple fields. Each field has its own validation rules. The caller expects <em>all</em> validation failures in a single response, not one at a time. The Service Stack's short-circuit behaviour is wrong here; you need error accumulation.</p>
<pre style="line-height:1.5;font-size:0.95em">
    <span style="color:#4CAF50">validateName ════●═══╗</span>
                        ║
    <span style="color:#4CAF50">validateEmail ═══●═══╬═══ zipWith3Accum ═══●═══▶  Registration</span>
                        ║
    <span style="color:#4CAF50">validateAge ════●════╝</span>

    If any fail, errors <b>accumulate</b> (not short-circuit):

    <span style="color:#F44336">validateName ────●───╗</span>
    <span style="color:#F44336">  "Name too short"   ║</span>
                        <span style="color:#F44336">╠═══ zipWith3Accum ═══●═══▶  List[err1, err2]</span>
    <span style="color:#F44336">validateEmail ───●───╝</span>
    <span style="color:#F44336">  "Invalid email"</span>
                        ║
    <span style="color:#4CAF50">validateAge ════●════╝</span>
    <span style="color:#4CAF50">  (valid, but still</span>
    <span style="color:#4CAF50">   collected with errors)</span>
</pre>
<h3 id="the-solution-2"><a class="header" href="#the-solution-2">The solution</a></h3>
<pre><code class="language-java">Semigroup&lt;List&lt;String&gt;&gt; errors = Semigroups.list();

ValidationPath&lt;List&lt;String&gt;, String&gt; validateName(String name) {
    return name != null &amp;&amp; name.length() &gt;= 2
        ? Path.valid(name, errors)
        : Path.invalid(List.of("Name must be at least 2 characters"), errors);
}

ValidationPath&lt;List&lt;String&gt;, String&gt; validateEmail(String email) {
    return email != null &amp;&amp; email.contains("@")
        ? Path.valid(email, errors)
        : Path.invalid(List.of("Invalid email format"), errors);
}

// Accumulate ALL errors, not just the first
ValidationPath&lt;List&lt;String&gt;, Registration&gt; validateRequest(RegistrationRequest req) {
    return validateName(req.name())
        .zipWith3Accum(
            validateEmail(req.email()),
            validateAge(req.age()),
            Registration::new
        );
}
// Invalid case returns: List["Name must be at least 2 characters", "Invalid email format"]
</code></pre>
<h3 id="when-to-use-2"><a class="header" href="#when-to-use-2">When to use</a></h3>
<p>API request validation, form input checking, configuration file parsing; anywhere the user benefits from seeing all problems at once. If you only need the first error, the Service Stack is simpler.</p>
<h3 id="the-imperative-alternative-2"><a class="header" href="#the-imperative-alternative-2">The imperative alternative</a></h3>
<pre><code class="language-java">// Without ValidationPath: manual error list accumulation
List&lt;String&gt; errors = new ArrayList&lt;&gt;();
if (name == null || name.length() &lt; 2) errors.add("Name must be at least 2 characters");
if (email == null || !email.contains("@")) errors.add("Invalid email format");
if (age &lt; 0 || age &gt; 150) errors.add("Age must be between 0 and 150");
if (!errors.isEmpty()) return ResponseEntity.badRequest().body(errors);
// ... proceed with validated data (but the types don't prove it's valid)
</code></pre>
<hr />
<h2 id="the-context-stack"><a class="header" href="#the-context-stack">The Context Stack</a></h2>
<p><strong>Path type:</strong> <code>ReaderPath&lt;R, A&gt;</code>
<strong>Underlying type:</strong> <code>Reader&lt;R, A&gt;</code>
<strong>Raw transformer:</strong> <code>ReaderT&lt;F, R, A&gt;</code></p>
<h3 id="the-problem-3"><a class="header" href="#the-problem-3">The problem</a></h3>
<p>In a multi-tenant SaaS application, every service call needs access to tenant context: the tenant ID, feature flags, rate limits, and the current user's permissions. Passing this context through every method parameter is tedious, error-prone, and clutters every signature. Spring's <code>@Autowired</code> solves this for singletons, but not for request-scoped data.</p>
<h3 id="the-solution-3"><a class="header" href="#the-solution-3">The solution</a></h3>
<pre><code class="language-java">record TenantContext(String tenantId, Set&lt;String&gt; featureFlags) {}

// Service methods declare their dependency on context without receiving it yet
ReaderPath&lt;TenantContext, PricingPlan&gt; resolvePricing() {
    return Path.&lt;TenantContext&gt;ask()
        .map(ctx -&gt; ctx.featureFlags().contains("premium")
            ? PricingPlan.PREMIUM
            : PricingPlan.STANDARD);
}

ReaderPath&lt;TenantContext, List&lt;Product&gt;&gt; listProducts() {
    return Path.&lt;TenantContext&gt;ask()
        .map(ctx -&gt; catalog.findByTenant(ctx.tenantId()));
}

// Compose without mentioning context at intermediate steps
ReaderPath&lt;TenantContext, ProductPage&gt; buildProductPage() {
    return resolvePricing()
        .zipWith(listProducts(), ProductPage::new);
}

// Provide context once, at the edge
ProductPage page = buildProductPage().run(currentTenantContext);
</code></pre>
<h3 id="when-to-use-3"><a class="header" href="#when-to-use-3">When to use</a></h3>
<p>Multi-tenant systems, distributed tracing (threading trace IDs), security contexts (current user, permissions), or any situation where multiple service methods need shared request-scoped data. Particularly valuable in non-Spring contexts or when you need explicit, testable context management.</p>
<h3 id="the-imperative-alternative-3"><a class="header" href="#the-imperative-alternative-3">The imperative alternative</a></h3>
<pre><code class="language-java">// Without ReaderPath: context pollutes every signature
PricingPlan resolvePricing(TenantContext ctx) { ... }
List&lt;Product&gt; listProducts(TenantContext ctx) { ... }
ProductPage buildProductPage(TenantContext ctx) {
    return new ProductPage(resolvePricing(ctx), listProducts(ctx));
}
</code></pre>
<hr />
<h2 id="the-audit-stack"><a class="header" href="#the-audit-stack">The Audit Stack</a></h2>
<p><strong>Path type:</strong> <code>WriterPath&lt;W, A&gt;</code>
<strong>Underlying type:</strong> <code>Writer&lt;W, A&gt;</code>
<strong>No direct transformer in Higher-Kinded-J</strong> (use <code>WriterPath</code> directly)</p>
<h3 id="the-problem-4"><a class="header" href="#the-problem-4">The problem</a></h3>
<p>Financial regulations require every step in a transaction to produce an audit entry. The audit log must be accumulated alongside the computation, not scattered across side-effecting logger calls that are invisible in the type system and easily forgotten.</p>
<pre style="line-height:1.5;font-size:0.95em">
    <span style="color:#4CAF50"><b>Value</b>   ═══●══════════════●══════════════●═══▶  TransferResult</span>
    <span style="color:#4CAF50">         debit          credit         map</span>
              │                │
              ▼ <i>siding</i>        ▼ <i>siding</i>
    <span style="color:#FFB300"><b>Log</b>     ──●──────────────●──────────────────▶  [DEBIT, CREDIT]</span>
    <span style="color:#FFB300">       [DEBIT ...]    [CREDIT ...]</span>
    <span style="color:#FFB300">                 accumulated via Monoid</span>
</pre>
<h3 id="the-solution-4"><a class="header" href="#the-solution-4">The solution</a></h3>
<pre><code class="language-java">Monoid&lt;List&lt;AuditEntry&gt;&gt; auditMonoid = Monoids.list();

WriterPath&lt;List&lt;AuditEntry&gt;, Account&gt; debitAccount(Account account, double amount) {
    Account updated = account.withBalance(account.balance() - amount);
    return WriterPath.writer(
        updated,
        List.of(new AuditEntry("DEBIT", amount + " from " + account.id())),
        auditMonoid
    );
}

WriterPath&lt;List&lt;AuditEntry&gt;, TransferResult&gt; transfer(Account from, Account to, double amount) {
    return debitAccount(from, amount)
        .via(debited -&gt; creditAccount(to, amount))
        .map(credited -&gt; new TransferResult(from.id(), to.id(), amount));
}

// Extract both result and accumulated audit trail
Writer&lt;List&lt;AuditEntry&gt;, TransferResult&gt; result = transfer(from, to, 500.0).run();
TransferResult outcome = result.value();
List&lt;AuditEntry&gt; auditTrail = result.log();      // every step's audit entries, in order
</code></pre>
<h3 id="when-to-use-4"><a class="header" href="#when-to-use-4">When to use</a></h3>
<p>Compliance-sensitive operations (financial transactions, healthcare record access, permission changes), structured logging where the log must travel with the computation, or any pipeline where you need a provable record of every step.</p>
<h3 id="the-imperative-alternative-4"><a class="header" href="#the-imperative-alternative-4">The imperative alternative</a></h3>
<pre><code class="language-java">// Without WriterPath: side-effecting logger calls, easy to forget
Account debitAccount(Account account, double amount) {
    logger.info("DEBIT {} from {}", amount, account.id());  // easy to forget this line
    return account.withBalance(account.balance() - amount);
}
// The audit trail is scattered across log files, not attached to the result
</code></pre>
<hr />
<h2 id="the-workflow-stack"><a class="header" href="#the-workflow-stack">The Workflow Stack</a></h2>
<p><strong>Path type:</strong> <code>WithStatePath&lt;S, A&gt;</code>
<strong>Underlying type:</strong> <code>State&lt;S, A&gt;</code>
<strong>Raw transformer:</strong> <code>StateT&lt;S, F, A&gt;</code></p>
<h3 id="the-problem-5"><a class="header" href="#the-problem-5">The problem</a></h3>
<p>An order fulfilment pipeline must track its current state as it progresses through stages: <code>Pending</code>, <code>Validated</code>, <code>Paid</code>, <code>Shipped</code>. Each step can inspect and update the state. With mutable fields, the state transitions are implicit and hard to test. With immutable records, you end up threading the state through every method return value manually.</p>
<h3 id="the-solution-5"><a class="header" href="#the-solution-5">The solution</a></h3>
<pre><code class="language-java">enum OrderStage { PENDING, VALIDATED, PAID, SHIPPED }

record OrderState(OrderStage stage, List&lt;String&gt; events) {
    OrderState advance(OrderStage next, String event) {
        var updated = new java.util.ArrayList&lt;&gt;(events);
        updated.add(event);
        return new OrderState(next, List.copyOf(updated));
    }
}

WithStatePath&lt;OrderState, Unit&gt; validateOrder() {
    return WithStatePath.&lt;OrderState&gt;modify(
        s -&gt; s.advance(OrderStage.VALIDATED, "Order validated")
    );
}

WithStatePath&lt;OrderState, Unit&gt; processPayment() {
    return WithStatePath.&lt;OrderState&gt;modify(
        s -&gt; s.advance(OrderStage.PAID, "Payment processed")
    );
}

// Compose steps; state threads through automatically
WithStatePath&lt;OrderState, OrderState&gt; fulfil() {
    return validateOrder()
        .then(() -&gt; processPayment())
        .then(() -&gt; shipOrder())
        .then(WithStatePath::get);  // return final state
}

// Run with initial state
OrderState initial = new OrderState(OrderStage.PENDING, List.of());
OrderState finalState = fulfil().evalState(initial);
// OrderState[stage=SHIPPED, events=[Order validated, Payment processed, Order shipped]]
</code></pre>
<h3 id="when-to-use-5"><a class="header" href="#when-to-use-5">When to use</a></h3>
<p>Order processing pipelines, approval workflows, multi-step wizards, game state, or any computation where the state evolves through a defined sequence of transitions. Particularly powerful when combined with sealed types for the state, ensuring only valid transitions compile.</p>
<h3 id="the-imperative-alternative-5"><a class="header" href="#the-imperative-alternative-5">The imperative alternative</a></h3>
<pre><code class="language-java">// Without WithStatePath: mutable state, implicit transitions
class OrderProcessor {
    private OrderStage stage = OrderStage.PENDING;
    private final List&lt;String&gt; events = new ArrayList&lt;&gt;();

    void validate() { stage = OrderStage.VALIDATED; events.add("..."); }
    void pay()      { stage = OrderStage.PAID;      events.add("..."); }
    // State is mutable, transitions are unchecked, testing requires reset
}
</code></pre>
<hr />
<h2 id="the-safe-recursion-stack"><a class="header" href="#the-safe-recursion-stack">The Safe Recursion Stack</a></h2>
<p><strong>Path type:</strong> <code>TrampolinePath&lt;A&gt;</code>
<strong>Underlying type:</strong> <code>Trampoline&lt;A&gt;</code>
<strong>No transformer equivalent</strong> (base effect for stack safety)</p>
<h3 id="the-problem-6"><a class="header" href="#the-problem-6">The problem</a></h3>
<p>You are aggregating data from a paginated external API. Each page returns a "next cursor" if more data exists. A naive recursive implementation overflows the stack after a few thousand pages. The JVM does not support tail-call optimisation.</p>
<h3 id="the-solution-6"><a class="header" href="#the-solution-6">The solution</a></h3>
<pre><code class="language-java">TrampolinePath&lt;List&lt;Record&gt;&gt; fetchAllPages(String cursor, List&lt;Record&gt; accumulated) {
    Page page = api.fetch(cursor);
    List&lt;Record&gt; all = new ArrayList&lt;&gt;(accumulated);
    all.addAll(page.records());

    if (page.nextCursor() == null) {
        return TrampolinePath.done(List.copyOf(all));           // base case
    }
    return TrampolinePath.defer(                                // recursive case
        () -&gt; fetchAllPages(page.nextCursor(), all)             // no stack growth
    );
}

// Safe even for millions of pages
List&lt;Record&gt; allRecords = fetchAllPages(initialCursor, List.of()).run();
</code></pre>
<h3 id="when-to-use-6"><a class="header" href="#when-to-use-6">When to use</a></h3>
<p>Paginated API aggregation, tree traversals, graph algorithms, recursive data transformations; any recursive algorithm that might exceed the JVM's stack depth. If your recursion depth is bounded to a small number (under a few hundred), plain recursion is fine.</p>
<h3 id="the-imperative-alternative-6"><a class="header" href="#the-imperative-alternative-6">The imperative alternative</a></h3>
<pre><code class="language-java">// Without TrampolinePath: manual loop (works, but less composable)
List&lt;Record&gt; all = new ArrayList&lt;&gt;();
String cursor = initialCursor;
while (cursor != null) {
    Page page = api.fetch(cursor);
    all.addAll(page.records());
    cursor = page.nextCursor();
}
</code></pre>
<hr />
<h2 id="combining-archetypes"><a class="header" href="#combining-archetypes">Combining Archetypes</a></h2>
<p>Real applications rarely use a single archetype in isolation. The Order Processing example in the Examples Gallery demonstrates multiple archetypes working together:</p>
<ul>
<li><strong>Service Stack</strong> (<code>EitherPath</code>) for the main workflow with typed <code>OrderError</code></li>
<li><strong>Validation Stack</strong> (<code>ValidationPath</code>) for input validation before processing</li>
<li><strong>Context Stack</strong> (<code>ReaderPath</code>) for threading <code>WorkflowConfig</code> through the pipeline</li>
<li><strong>Audit Stack</strong> (<code>WriterPath</code>) for compliance logging via <code>AuditLogWriter</code></li>
</ul>
<p>The Path API's conversion methods (<code>toEitherPath</code>, <code>toMaybePath</code>, <code>toValidationPath</code>) make it straightforward to transition between archetypes at natural boundaries in your pipeline.</p>
<pre><code class="language-java">// Validate first (accumulate all errors), then switch to service stack (short-circuit)
EitherPath&lt;OrderError, ValidatedOrder&gt; validated =
    validateRequest(request)                          // ValidationPath (accumulate)
        .toEitherPath()                               // switch to EitherPath
        .mapError(errors -&gt; new OrderError.Invalid(errors));

// Thread context through the validated pipeline
ReaderPath&lt;WorkflowConfig, EitherPath&lt;OrderError, OrderResult&gt;&gt; pipeline =
    Path.&lt;WorkflowConfig&gt;ask()
        .map(config -&gt; validated.via(order -&gt; processOrder(order, config)));
</code></pre>
<hr />
<h2 id="archetypes-vs-raw-transformers"><a class="header" href="#archetypes-vs-raw-transformers">Archetypes vs Raw Transformers</a></h2>
<p>Each archetype's Path type provides a fluent, concrete API. For most use cases, you never need the raw transformer. The table below shows the correspondence for when you do need to drop down:</p>
<div class="table-wrapper"><table><thead><tr><th>Path Type</th><th>Corresponding Transformer</th><th>When to Use the Transformer</th></tr></thead><tbody>
<tr><td><code>EitherPath&lt;E, A&gt;</code></td><td><code>EitherT&lt;F, E, A&gt;</code></td><td>Combining typed errors with a <em>different</em> outer monad (e.g. <code>CompletableFuture</code>)</td></tr>
<tr><td><code>MaybePath&lt;A&gt;</code></td><td><code>MaybeT&lt;F, A&gt;</code></td><td>Combining absence with a different outer monad</td></tr>
<tr><td><code>OptionalPath&lt;A&gt;</code></td><td><code>OptionalT&lt;F, A&gt;</code></td><td>Same as MaybeT, for <code>java.util.Optional</code> users</td></tr>
<tr><td><code>ReaderPath&lt;R, A&gt;</code></td><td><code>ReaderT&lt;F, R, A&gt;</code></td><td>Combining environment reading with a different outer monad</td></tr>
<tr><td><code>WithStatePath&lt;S, A&gt;</code></td><td><code>StateT&lt;S, F, A&gt;</code></td><td>Combining state with a different outer monad</td></tr>
<tr><td><code>ValidationPath&lt;E, A&gt;</code></td><td><em>(no transformer)</em></td><td>Always use the Path type directly</td></tr>
<tr><td><code>WriterPath&lt;W, A&gt;</code></td><td><em>(no transformer)</em></td><td>Always use the Path type directly</td></tr>
<tr><td><code>TrampolinePath&lt;A&gt;</code></td><td><em>(no transformer)</em></td><td>Always use the Path type directly</td></tr>
</tbody></table>
</div><div id="admonition-see-also" class="admonition admonish-tip" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See Also</p>
</div>
<a class="admonition-anchor-link" href="#admonition-see-also"></a>
</div>
<div>
<ul>
<li><a href="../effect/effect_path_overview.html">Effect Path Overview</a> - The railway model and how Path types work</li>
<li><a href="../effect/path_types.html">Path Types</a> - Detailed reference for every Path type</li>
<li><a href="../examples/examples_order.html">Order Processing Workflow</a> - Full-scale example combining multiple archetypes</li>
<li><a href="transformers.html">Monad Transformers</a> - The raw transformer machinery underneath</li>
</ul>
</div>
</div>
<hr />
<p><strong>Previous:</strong> <a href="ch_intro.html">Introduction</a>
<strong>Next:</strong> <a href="transformers.html">Monad Transformers</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../transformers/ch_intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../transformers/transformers.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../transformers/ch_intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../transformers/transformers.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../version-switcher.js"></script>
        <script src=".././theme/version-switcher.js"></script>
        <script src=".././theme/sidebar-nav-link.js"></script>


    </div>
    </body>
</html>
