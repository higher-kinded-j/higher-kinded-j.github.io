<!DOCTYPE HTML>
<html lang="en" class="latte sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Patterns and Recipes - Higher-Kinded-J: Composable Effects and Advanced Optics for Java</title>


        <!-- Custom HTML head -->


            <meta name="description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">


        <meta name="keywords" content="Higher-Kinded Types, Higher-Kinded-J, HKT, Java, Optics, Lens, Prism, Traversal, Iso, Affine, Focus DSL, Effect Path API, Functional Programming, Monad, Functor, Applicative, EitherPath, MaybePath, TryPath, ValidationPath, Java Records, Sealed Interface, Error Handling, Immutable Data">
        
        <meta property="og:title" content="Patterns and Recipes - Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
            <meta property="og:description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://higher-kinded-j.github.io/">
        <meta property="og:image" content="https://higher-kinded-j.github.io/preview.png">
        <meta property="og:image:width" content="1200">
        <meta property="og:image:height" content="630">
        <meta property="og:site_name" content="Higher-Kinded-J Documentation">
        <meta property="og:locale" content="en_GB">
        
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="Patterns and Recipes - Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
        <meta name="twitter:description" content="Unifying Composable Effects and Advanced Optics for Java. Effect Path API, Focus DSL, and the most comprehensive optics implementation in the Java ecosystem.">
        <meta name="twitter:image" content="https://higher-kinded-j.github.io/preview.png">
        <meta name="twitter:image:alt" content="Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
        <meta name="description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">
        <meta name="google-site-verification" content="X-xsiAq2cKMLOzh9dexUrX8Onx2h_YMUFgp5lHHUwSg" />
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin.css">
        <link rel="stylesheet" href=".././theme/catppuccin-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin-alerts.css">
        <link rel="stylesheet" href=".././theme/additional-hkj.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "latte";
            const default_dark_theme = "macchiato";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('latte')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frappé</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        <div class="version-selector-container">
                            <select id="version-selector" class="version-selector" aria-label="Select documentation version" title="Select documentation version">
                                <option value="">Loading versions...</option>
                            </select>
                        </div>
                    </div>

                    <h1 class="menu-title">Higher-Kinded-J: Composable Effects and Advanced Optics for Java</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j/edit/main/hkj-book/src/effect/patterns.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="patterns-and-recipes"><a class="header" href="#patterns-and-recipes">Patterns and Recipes</a></h1>
<blockquote>
<p><em>"When the going gets weird, the weird turn professional."</em></p>
<p>-- Hunter S. Thompson, <em>Fear and Loathing on the Campaign Trail '72</em></p>
</blockquote>
<p>Every codebase eventually gets weird. Edge cases multiply. Requirements
contradict. Legacy systems refuse to behave. The patterns in this chapter
are for those moments: tested approaches from production code where the
weird was met professionally.</p>
<p>These aren't academic exercises. They're recipes that survived contact with
reality.</p>
<div id="admonition-what-youll-learn" class="admonition admonish-info" role="note" aria-labelledby="admonition-what-youll-learn-title">
<div class="admonition-title">
<div id="admonition-what-youll-learn-title">
<p>What You'll Learn</p>
</div>
<a class="admonition-anchor-link" href="#admonition-what-youll-learn"></a>
</div>
<div>
<ul>
<li>Validation pipeline patterns for single fields and combined validations</li>
<li>Service layer patterns for repositories and chained service calls</li>
<li>IO effect patterns for resource management and composing effects</li>
<li>Error handling strategies: enrichment, recovery with logging, circuit breakers</li>
<li>Testing patterns for Path-returning methods</li>
<li>Integration patterns with existing code</li>
</ul>
</div>
</div>
<hr />
<h2 id="validation-pipelines"><a class="header" href="#validation-pipelines">Validation Pipelines</a></h2>
<p>User input arrives untrustworthy. Every field might be missing, malformed,
or actively hostile. Traditional validation scatters null checks and
conditionals throughout your code. Path types let you build validation as
composable pipelines where each rule is small, testable, and reusable.</p>
<h3 id="single-field-validation"><a class="header" href="#single-field-validation">Single Field Validation</a></h3>
<p>Each field gets its own validation function returning a Path:</p>
<pre><code class="language-java">private EitherPath&lt;String, String&gt; validateEmail(String email) {
    if (email == null || email.isBlank()) {
        return Path.left("Email is required");
    }
    if (!email.contains("@")) {
        return Path.left("Email must contain @");
    }
    if (!email.contains(".")) {
        return Path.left("Email must contain a domain");
    }
    return Path.right(email.toLowerCase().trim());
}
</code></pre>
<p>Or with modern pattern matching:</p>
<pre><code class="language-java">private EitherPath&lt;String, String&gt; validateEmail(String email) {
    return switch (email) {
        case null -&gt; Path.left("Email is required");
        case String e when e.isBlank() -&gt; Path.left("Email is required");
        case String e when !e.contains("@") -&gt; Path.left("Email must contain @");
        case String e when !e.contains(".") -&gt; Path.left("Email must have a domain");
        case String e -&gt; Path.right(e.toLowerCase().trim());
    };
}
</code></pre>
<p>The validated value may be transformed (lowercase, trimmed); the Path
carries the clean version forward.</p>
<h3 id="combining-validations-fail-fast"><a class="header" href="#combining-validations-fail-fast">Combining Validations (Fail-Fast)</a></h3>
<p>When all fields must be valid to proceed:</p>
<pre><code class="language-java">record User(String name, String email, int age) {}

EitherPath&lt;String, User&gt; validateUser(UserInput input) {
    return validateName(input.name())
        .zipWith3(
            validateEmail(input.email()),
            validateAge(input.age()),
            User::new
        );
}
</code></pre>
<p>First failure stops processing. For user-facing forms, this is often too
abrupt; see the next pattern.</p>
<h3 id="combining-validations-accumulating"><a class="header" href="#combining-validations-accumulating">Combining Validations (Accumulating)</a></h3>
<p>When users deserve to see all problems at once:</p>
<pre><code class="language-java">ValidationPath&lt;List&lt;String&gt;, User&gt; validateUser(UserInput input) {
    return validateNameV(input.name())
        .zipWith3Accum(
            validateEmailV(input.email()),
            validateAgeV(input.age()),
            User::new
        );
}

// Usage
validateUser(input).run().fold(
    errors -&gt; showAllErrors(errors),  // ["Name too short", "Invalid email"]
    user -&gt; proceed(user)
);
</code></pre>
<p>The difference is respect for the user's time.</p>
<h3 id="nested-validation"><a class="header" href="#nested-validation">Nested Validation</a></h3>
<p>Complex objects with nested structures:</p>
<pre><code class="language-java">record Registration(User user, Address address, List&lt;Preference&gt; prefs) {}

EitherPath&lt;String, Registration&gt; validateRegistration(RegistrationInput input) {
    EitherPath&lt;String, User&gt; user = validateUser(input.user());

    EitherPath&lt;String, Address&gt; address = validateStreet(input.street())
        .zipWith3(
            validateCity(input.city()),
            validatePostcode(input.postcode()),
            Address::new
        );

    EitherPath&lt;String, List&lt;Preference&gt;&gt; prefs =
        validatePreferences(input.preferences());

    return user.zipWith3(address, prefs, Registration::new);
}
</code></pre>
<p>Each sub-validation is independent; they combine at the end.</p>
<hr />
<h2 id="service-layer-patterns"><a class="header" href="#service-layer-patterns">Service Layer Patterns</a></h2>
<p>Services orchestrate multiple operations: fetching data, applying business
rules, calling external systems. Each step might fail differently. Path types
make the orchestration explicit.</p>
<h3 id="repository-pattern"><a class="header" href="#repository-pattern">Repository Pattern</a></h3>
<p>Repositories return <code>Maybe</code> (absence is expected). Services convert to
<code>Either</code> (absence becomes an error in context):</p>
<pre><code class="language-java">public class UserRepository {
    public Maybe&lt;User&gt; findById(String id) {
        return Maybe.fromOptional(
            jdbcTemplate.queryForOptional("SELECT...", id)
        );
    }

    public Maybe&lt;User&gt; findByEmail(String email) {
        return Maybe.fromOptional(
            jdbcTemplate.queryForOptional("SELECT...", email)
        );
    }
}

public class UserService {
    private final UserRepository repository;

    public EitherPath&lt;UserError, User&gt; getById(String id) {
        return Path.maybe(repository.findById(id))
            .toEitherPath(() -&gt; new UserError.NotFound(id));
    }

    public EitherPath&lt;UserError, User&gt; getByEmail(String email) {
        return Path.maybe(repository.findByEmail(email))
            .toEitherPath(() -&gt; new UserError.NotFound(email));
    }
}
</code></pre>
<p>The conversion happens at the layer boundary. Repository callers get <code>Maybe</code>;
service callers get <code>Either</code> with meaningful errors.</p>
<h3 id="chained-service-calls"><a class="header" href="#chained-service-calls">Chained Service Calls</a></h3>
<p>When each step depends on the previous:</p>
<pre><code class="language-java">public class OrderService {
    private final UserService users;
    private final InventoryService inventory;
    private final PaymentService payments;

    public EitherPath&lt;OrderError, Order&gt; placeOrder(
            String userId, List&lt;Item&gt; items) {
        return users.getById(userId)
            .mapError(OrderError::fromUserError)
            .via(user -&gt; inventory.reserve(items)
                .mapError(OrderError::fromInventoryError))
            .via(reservation -&gt; payments.charge(user, reservation.total())
                .mapError(OrderError::fromPaymentError))
            .via(payment -&gt; Path.right(
                createOrder(user, items, payment)));
    }
}
</code></pre>
<p>Each <code>mapError</code> translates the sub-service error into the order domain.
The final <code>Order</code> is created only if all steps succeed.</p>
<h3 id="service-with-fallbacks"><a class="header" href="#service-with-fallbacks">Service with Fallbacks</a></h3>
<p>When multiple sources can satisfy a request:</p>
<pre><code class="language-java">public class ConfigService {
    public EitherPath&lt;ConfigError, Config&gt; loadConfig() {
        return Path.either(loadFromFile())
            .recoverWith(e -&gt; {
                log.warn("File config unavailable: {}", e.getMessage());
                return Path.either(loadFromEnvironment());
            })
            .recoverWith(e -&gt; {
                log.warn("Env config unavailable: {}", e.getMessage());
                return Path.right(Config.defaults());
            });
    }
}
</code></pre>
<p>The logs record what was tried; the caller gets a working config or a clear
failure.</p>
<hr />
<h2 id="io-effect-patterns"><a class="header" href="#io-effect-patterns">IO Effect Patterns</a></h2>
<h3 id="resource-management"><a class="header" href="#resource-management">Resource Management</a></h3>
<p>Acquire, use, release, regardless of success or failure:</p>
<pre><code class="language-java">public class FileProcessor {
    public IOPath&lt;ProcessResult&gt; process(Path path) {
        return Path.io(() -&gt; new BufferedReader(new FileReader(path.toFile())))
            .via(reader -&gt; Path.io(() -&gt; processContent(reader)))
            .ensuring(() -&gt; {
                // Cleanup runs regardless of outcome
                log.debug("Processing complete: {}", path);
            });
    }
}
</code></pre>
<p>For true resource safety with acquisition and release:</p>
<pre><code class="language-java">public IOPath&lt;Result&gt; withConnection(Function&lt;Connection, Result&gt; action) {
    return Path.io(() -&gt; dataSource.getConnection())
        .via(conn -&gt; Path.io(() -&gt; action.apply(conn))
            .ensuring(() -&gt; {
                try { conn.close(); }
                catch (SQLException e) { log.warn("Close failed", e); }
            }));
}
</code></pre>
<h3 id="composing-effect-pipelines"><a class="header" href="#composing-effect-pipelines">Composing Effect Pipelines</a></h3>
<p>Build complex pipelines that execute later:</p>
<pre><code class="language-java">public class DataPipeline {
    public IOPath&lt;Report&gt; generateReport(ReportRequest request) {
        return Path.io(() -&gt; log.info("Starting report: {}", request.id()))
            .then(() -&gt; Path.io(() -&gt; fetchData(request)))
            .via(data -&gt; Path.io(() -&gt; transform(data)))
            .via(transformed -&gt; Path.io(() -&gt; aggregate(transformed)))
            .via(aggregated -&gt; Path.io(() -&gt; format(aggregated)))
            .peek(report -&gt; log.info("Report ready: {} rows", report.rowCount()));
    }
}

// Nothing happens until:
Report report = pipeline.generateReport(request).unsafeRun();
</code></pre>
<h3 id="expressing-parallel-intent"><a class="header" href="#expressing-parallel-intent">Expressing Parallel Intent</a></h3>
<p>While <code>IOPath</code> doesn't parallelise automatically, <code>zipWith</code> expresses
independence:</p>
<pre><code class="language-java">IOPath&lt;CombinedData&gt; fetchAll() {
    IOPath&lt;UserData&gt; users = Path.io(() -&gt; fetchUsers());
    IOPath&lt;ProductData&gt; products = Path.io(() -&gt; fetchProducts());
    IOPath&lt;OrderData&gt; orders = Path.io(() -&gt; fetchOrders());

    return users.zipWith3(products, orders, CombinedData::new);
}
</code></pre>
<p>A more sophisticated runtime could parallelise these. For now, they execute
in sequence, but the structure is clear.</p>
<hr />
<h2 id="error-handling-strategies"><a class="header" href="#error-handling-strategies">Error Handling Strategies</a></h2>
<h3 id="error-enrichment"><a class="header" href="#error-enrichment">Error Enrichment</a></h3>
<p>Add context as errors propagate through layers:</p>
<pre><code class="language-java">public &lt;A&gt; EitherPath&lt;DetailedError, A&gt; withContext(
        EitherPath&lt;Error, A&gt; path,
        String operation,
        Map&lt;String, Object&gt; context) {
    return path.mapError(error -&gt; new DetailedError(
        error,
        operation,
        context,
        Instant.now()
    ));
}

// Usage
return withContext(
    userService.getUser(id),
    "getUser",
    Map.of("userId", id, "requestId", requestId)
);
</code></pre>
<p>When the error surfaces, you know what was happening and with what parameters.</p>
<h3 id="recovery-with-logging"><a class="header" href="#recovery-with-logging">Recovery with Logging</a></h3>
<p>Log the failure, provide a fallback:</p>
<pre><code class="language-java">public &lt;A&gt; EitherPath&lt;Error, A&gt; withRecoveryLogging(
        EitherPath&lt;Error, A&gt; path,
        A fallback,
        String operation) {
    return path.recover(error -&gt; {
        log.warn("Operation '{}' failed: {}. Using fallback.",
            operation, error);
        return fallback;
    });
}
</code></pre>
<h3 id="circuit-breaker"><a class="header" href="#circuit-breaker">Circuit Breaker</a></h3>
<p>Stop calling a failing service:</p>
<pre><code class="language-java">public class CircuitBreaker&lt;E, A&gt; {
    private final AtomicInteger failures = new AtomicInteger(0);
    private final int threshold;
    private final Supplier&lt;EitherPath&lt;E, A&gt;&gt; fallback;

    public EitherPath&lt;E, A&gt; execute(Supplier&lt;EitherPath&lt;E, A&gt;&gt; operation) {
        if (failures.get() &gt;= threshold) {
            log.debug("Circuit open, using fallback");
            return fallback.get();
        }

        return operation.get()
            .peek(success -&gt; failures.set(0))
            .recoverWith(error -&gt; {
                int count = failures.incrementAndGet();
                log.warn("Failure {} of {}", count, threshold);
                return Path.left(error);
            });
    }
}
</code></pre>
<p>A proper implementation would include timeouts and half-open states. This
shows the pattern.</p>
<hr />
<h2 id="resilience-retry-with-backoff"><a class="header" href="#resilience-retry-with-backoff">Resilience: Retry with Backoff</a></h2>
<blockquote>
<p><em>"The protocol specified exponential backoff: wait one second, try again;
wait two seconds, try again; wait four seconds..."</em></p>
<p>-- Neal Stephenson, <em>Cryptonomicon</em></p>
</blockquote>
<p>Transient failures (network blips, brief overloads) often succeed on retry.
But retrying immediately can worsen the problem. The <code>RetryPolicy</code> API
provides configurable backoff strategies.</p>
<h3 id="creating-retry-policies"><a class="header" href="#creating-retry-policies">Creating Retry Policies</a></h3>
<pre><code class="language-java">// Fixed delay: 100ms between each of 3 attempts
RetryPolicy fixed = RetryPolicy.fixed(3, Duration.ofMillis(100));

// Exponential backoff: 1s, 2s, 4s, 8s...
RetryPolicy exponential = RetryPolicy.exponentialBackoff(5, Duration.ofSeconds(1));

// With jitter to prevent thundering herd
RetryPolicy jittered = RetryPolicy.exponentialBackoffWithJitter(5, Duration.ofSeconds(1));
</code></pre>
<h3 id="applying-retry-to-paths"><a class="header" href="#applying-retry-to-paths">Applying Retry to Paths</a></h3>
<pre><code class="language-java">IOPath&lt;Response&gt; resilient = IOPath.delay(() -&gt; httpClient.get(url))
    .withRetry(RetryPolicy.exponentialBackoff(3, Duration.ofSeconds(1)));

// Convenience method for simple cases
IOPath&lt;Response&gt; simple = IOPath.delay(() -&gt; httpClient.get(url))
    .retry(3);  // Uses default exponential backoff
</code></pre>
<h3 id="configuring-retry-behaviour"><a class="header" href="#configuring-retry-behaviour">Configuring Retry Behaviour</a></h3>
<p>Policies are immutable but configurable:</p>
<pre><code class="language-java">RetryPolicy policy = RetryPolicy.exponentialBackoff(5, Duration.ofMillis(100))
    .withMaxDelay(Duration.ofSeconds(30))   // Cap maximum wait
    .retryOn(IOException.class);             // Only retry I/O errors
</code></pre>
<h3 id="selective-retry"><a class="header" href="#selective-retry">Selective Retry</a></h3>
<p>Not all errors should trigger retry:</p>
<pre><code class="language-java">RetryPolicy selective = RetryPolicy.fixed(3, Duration.ofMillis(100))
    .retryIf(ex -&gt;
        ex instanceof IOException ||
        ex instanceof TimeoutException ||
        (ex instanceof HttpException http &amp;&amp; http.statusCode() &gt;= 500));
</code></pre>
<h3 id="combining-retry-with-fallback"><a class="header" href="#combining-retry-with-fallback">Combining Retry with Fallback</a></h3>
<pre><code class="language-java">IOPath&lt;Data&gt; robust = fetchFromPrimary()
    .withRetry(RetryPolicy.exponentialBackoff(3, Duration.ofSeconds(1)))
    .handleErrorWith(e -&gt; {
        log.warn("Primary exhausted, trying backup");
        return fetchFromBackup()
            .withRetry(RetryPolicy.fixed(2, Duration.ofMillis(100)));
    })
    .recover(e -&gt; {
        log.error("All sources failed", e);
        return Data.empty();
    });
</code></pre>
<h3 id="handling-exhausted-retries"><a class="header" href="#handling-exhausted-retries">Handling Exhausted Retries</a></h3>
<p>When all attempts fail, <code>RetryExhaustedException</code> is thrown:</p>
<pre><code class="language-java">try {
    resilient.unsafeRun();
} catch (RetryExhaustedException e) {
    log.error("All retries failed: {}", e.getMessage());
    Throwable lastFailure = e.getCause();
    return fallbackValue;
}
</code></pre>
<h3 id="retry-pattern-quick-reference"><a class="header" href="#retry-pattern-quick-reference">Retry Pattern Quick Reference</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Strategy</th><th>Use Case</th></tr></thead><tbody>
<tr><td><code>fixed(n, delay)</code></td><td>Known recovery time</td></tr>
<tr><td><code>exponentialBackoff(n, initial)</code></td><td>Unknown recovery time</td></tr>
<tr><td><code>exponentialBackoffWithJitter(n, initial)</code></td><td>Multiple clients retrying</td></tr>
<tr><td><code>.retryOn(ExceptionType.class)</code></td><td>Selective retry</td></tr>
<tr><td><code>.withMaxDelay(duration)</code></td><td>Cap exponential growth</td></tr>
</tbody></table>
</div><div id="admonition-see-also" class="admonition admonish-tip" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See Also</p>
</div>
<a class="admonition-anchor-link" href="#admonition-see-also"></a>
</div>
<div>
<p>See <a href="advanced_topics.html">Advanced Effect Topics</a> for comprehensive coverage of
resilience patterns including resource management with <code>bracket</code> and <code>guarantee</code>.</p>
</div>
</div>
<hr />
<h2 id="testing-patterns"><a class="header" href="#testing-patterns">Testing Patterns</a></h2>
<p>Path-returning methods are straightforward to test. The explicit success/failure
encoding means you can verify both paths without exception handling gymnastics.</p>
<h3 id="testing-success-and-failure"><a class="header" href="#testing-success-and-failure">Testing Success and Failure</a></h3>
<pre><code class="language-java">@Test
void shouldReturnUserWhenFound() {
    when(repository.findById("123")).thenReturn(Maybe.just(testUser));

    EitherPath&lt;UserError, User&gt; result = service.getUser("123");

    assertThat(result.run().isRight()).isTrue();
    assertThat(result.run().getRight()).isEqualTo(testUser);
}

@Test
void shouldReturnErrorWhenNotFound() {
    when(repository.findById("123")).thenReturn(Maybe.nothing());

    EitherPath&lt;UserError, User&gt; result = service.getUser("123");

    assertThat(result.run().isLeft()).isTrue();
    assertThat(result.run().getLeft()).isInstanceOf(UserError.NotFound.class);
}
</code></pre>
<h3 id="testing-error-propagation"><a class="header" href="#testing-error-propagation">Testing Error Propagation</a></h3>
<p>Verify that errors from nested operations surface correctly:</p>
<pre><code class="language-java">@Test
void shouldPropagatePaymentError() {
    when(userService.getUser(any())).thenReturn(Path.right(testUser));
    when(inventory.check(any())).thenReturn(Path.right(availability));
    when(payments.charge(any(), any()))
        .thenReturn(Path.left(new PaymentError("Declined")));

    EitherPath&lt;OrderError, Order&gt; result = orderService.placeOrder(request);

    assertThat(result.run().isLeft()).isTrue();
    assertThat(result.run().getLeft())
        .isInstanceOf(OrderError.PaymentFailed.class);

    // Order creation should never be called
    verify(orderRepository, never()).save(any());
}
</code></pre>
<h3 id="property-based-testing"><a class="header" href="#property-based-testing">Property-Based Testing</a></h3>
<p>Use jqwik or similar to verify laws across many inputs:</p>
<pre><code class="language-java">@Property
void functorIdentityLaw(@ForAll @StringLength(min = 1, max = 100) String value) {
    MaybePath&lt;String&gt; path = Path.just(value);
    MaybePath&lt;String&gt; mapped = path.map(Function.identity());

    assertThat(mapped.run()).isEqualTo(path.run());
}

@Property
void recoverAlwaysSucceeds(
        @ForAll String errorMessage,
        @ForAll String fallback) {
    EitherPath&lt;String, String&gt; failed = Path.left(errorMessage);
    EitherPath&lt;String, String&gt; recovered = failed.recover(e -&gt; fallback);

    assertThat(recovered.run().isRight()).isTrue();
    assertThat(recovered.run().getRight()).isEqualTo(fallback);
}
</code></pre>
<h3 id="testing-deferred-effects"><a class="header" href="#testing-deferred-effects">Testing Deferred Effects</a></h3>
<p>Verify that <code>IOPath</code> defers execution:</p>
<pre><code class="language-java">@Test
void shouldDeferExecution() {
    AtomicInteger callCount = new AtomicInteger(0);
    IOPath&lt;Integer&gt; io = Path.io(() -&gt; callCount.incrementAndGet());

    assertThat(callCount.get()).isEqualTo(0);  // Not yet

    int result = io.unsafeRun();

    assertThat(callCount.get()).isEqualTo(1);  // Now
    assertThat(result).isEqualTo(1);
}

@Test
void shouldCaptureExceptionInRunSafe() {
    IOPath&lt;String&gt; failing = Path.io(() -&gt; {
        throw new RuntimeException("test error");
    });

    Try&lt;String&gt; result = failing.runSafe();

    assertThat(result.isFailure()).isTrue();
    assertThat(result.getCause().getMessage()).isEqualTo("test error");
}
</code></pre>
<hr />
<h2 id="integration-with-existing-code"><a class="header" href="#integration-with-existing-code">Integration with Existing Code</a></h2>
<p>Real projects have legacy code that throws exceptions, returns <code>Optional</code>,
or uses patterns that predate functional error handling.</p>
<h3 id="wrapping-exception-throwing-apis"><a class="header" href="#wrapping-exception-throwing-apis">Wrapping Exception-Throwing APIs</a></h3>
<pre><code class="language-java">public class LegacyWrapper {
    private final LegacyService legacy;

    public TryPath&lt;Data&gt; fetchData(String id) {
        return Path.tryOf(() -&gt; legacy.fetchData(id));
    }

    public EitherPath&lt;ServiceError, Data&gt; fetchDataSafe(String id) {
        return Path.tryOf(() -&gt; legacy.fetchData(id))
            .toEitherPath(ex -&gt; new ServiceError("Fetch failed", ex));
    }
}
</code></pre>
<h3 id="wrapping-optional-returning-apis"><a class="header" href="#wrapping-optional-returning-apis">Wrapping Optional-Returning APIs</a></h3>
<pre><code class="language-java">public class ModernWrapper {
    private final ModernService modern;

    public MaybePath&lt;User&gt; findUser(String id) {
        return Path.maybe(Maybe.fromOptional(modern.findUser(id)));
    }
}
</code></pre>
<h3 id="exposing-to-non-path-consumers"><a class="header" href="#exposing-to-non-path-consumers">Exposing to Non-Path Consumers</a></h3>
<p>When callers expect traditional patterns:</p>
<pre><code class="language-java">public class ServiceAdapter {
    private final PathBasedService service;

    // For consumers expecting Optional
    public Optional&lt;User&gt; findUser(String id) {
        return service.findUser(id).run().toOptional();
    }

    // For consumers expecting exceptions
    public User getUser(String id) throws UserNotFoundException {
        Either&lt;UserError, User&gt; result = service.getUser(id).run();
        if (result.isLeft()) {
            throw new UserNotFoundException(result.getLeft().message());
        }
        return result.getRight();
    }
}
</code></pre>
<hr />
<h2 id="common-pitfalls"><a class="header" href="#common-pitfalls">Common Pitfalls</a></h2>
<h3 id="pitfall-1-excessive-conversion"><a class="header" href="#pitfall-1-excessive-conversion">Pitfall 1: Excessive Conversion</a></h3>
<pre><code class="language-java">// Wasteful
Path.maybe(findUser(id))
    .toEitherPath(() -&gt; error)
    .toMaybePath()
    .toEitherPath(() -&gt; error);

// Clean
Path.maybe(findUser(id))
    .toEitherPath(() -&gt; error);
</code></pre>
<h3 id="pitfall-2-side-effects-in-pure-operations"><a class="header" href="#pitfall-2-side-effects-in-pure-operations">Pitfall 2: Side Effects in Pure Operations</a></h3>
<pre><code class="language-java">// Wrong
path.map(user -&gt; {
    auditLog.record(user);  // Side effect in map!
    return user;
});

// Right
path.peek(user -&gt; auditLog.record(user));
</code></pre>
<h3 id="pitfall-3-ignoring-the-result"><a class="header" href="#pitfall-3-ignoring-the-result">Pitfall 3: Ignoring the Result</a></h3>
<pre><code class="language-java">// Bug: result discarded, nothing happens
void processOrder(OrderRequest request) {
    validateAndProcess(request);  // Returns EitherPath, ignored
}

// Fixed
void processOrder(OrderRequest request) {
    validateAndProcess(request).run();  // Actually execute
}
</code></pre>
<h3 id="pitfall-4-treating-all-errors-the-same"><a class="header" href="#pitfall-4-treating-all-errors-the-same">Pitfall 4: Treating All Errors the Same</a></h3>
<pre><code class="language-java">// Loses information
.mapError(e -&gt; "An error occurred")

// Preserves structure
.mapError(e -&gt; new DomainError(e.code(), e.message(), e))
</code></pre>
<hr />
<h2 id="quick-reference"><a class="header" href="#quick-reference">Quick Reference</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Pattern</th><th>When to Use</th><th>Key Methods</th></tr></thead><tbody>
<tr><td>Single validation</td><td>Validate one field</td><td><code>Path.right/left</code></td></tr>
<tr><td>Combined validation</td><td>Multiple independent fields</td><td><code>zipWith</code>, <code>zipWithAccum</code></td></tr>
<tr><td>Repository wrapping</td><td>Maybe → Either at boundary</td><td><code>toEitherPath</code></td></tr>
<tr><td>Service chaining</td><td>Sequential dependent calls</td><td><code>via</code>, <code>mapError</code></td></tr>
<tr><td>Fallback chain</td><td>Multiple sources</td><td><code>recoverWith</code></td></tr>
<tr><td>Resource management</td><td>Acquire/use/release</td><td><code>bracket</code>, <code>withResource</code></td></tr>
<tr><td>Cleanup guarantee</td><td>Ensure finalizer runs</td><td><code>guarantee</code></td></tr>
<tr><td>Effect pipeline</td><td>Deferred composition</td><td><code>via</code>, <code>then</code>, <code>unsafeRun</code></td></tr>
<tr><td>Error enrichment</td><td>Add context</td><td><code>mapError</code></td></tr>
<tr><td>Circuit breaker</td><td>Protect failing service</td><td><code>recover</code>, <code>recoverWith</code></td></tr>
<tr><td>Retry with backoff</td><td>Transient failures</td><td><code>withRetry</code>, <code>RetryPolicy</code></td></tr>
<tr><td>Selective retry</td><td>Specific exception types</td><td><code>.retryOn()</code>, <code>.retryIf()</code></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>The patterns in this chapter share a common theme: making the implicit explicit.
Error handling becomes visible in the types. Composition becomes visible in
the pipeline. Dependencies become visible in the choice of <code>via</code> vs <code>zipWith</code>.</p>
<p>When the going gets weird (and it will), these patterns are your professional
toolkit. They won't make the weirdness go away, but they'll help you handle
it with composure.</p>
<p>Continue to <a href="advanced_effects.html">Advanced Effects</a> for Reader, State, and
Writer patterns.</p>
<div id="admonition-see-also-1" class="admonition admonish-tip" role="note" aria-labelledby="admonition-see-also-1-title">
<div class="admonition-title">
<div id="admonition-see-also-1-title">
<p>See Also</p>
</div>
<a class="admonition-anchor-link" href="#admonition-see-also-1"></a>
</div>
<div>
<ul>
<li><a href="../monads/validated_monad.html">Validated Monad</a> - Accumulating validation errors</li>
<li><a href="../functional/monad_error.html">MonadError</a> - The type class behind error recovery</li>
<li><a href="../monads/io_monad.html">IO Monad</a> - Deferred effect execution</li>
</ul>
</div>
</div>
<hr />
<p><strong>Previous:</strong> <a href="focus_integration.html">Focus-Effect Integration</a>
<strong>Next:</strong> <a href="migration_cookbook.html">Migration Cookbook</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../effect/capstone_focus_effect.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../effect/migration_cookbook.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../effect/capstone_focus_effect.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../effect/migration_cookbook.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../version-switcher.js"></script>
        <script src=".././theme/version-switcher.js"></script>
        <script src=".././theme/sidebar-nav-link.js"></script>


    </div>
    </body>
</html>
