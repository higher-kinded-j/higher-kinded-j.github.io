<!DOCTYPE HTML>
<html lang="en" class="latte sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>For Comprehension - Higher-Kinded Types and Optics for Java</title>


        <!-- Custom HTML head -->


            <meta name="description" content="Explore Higher-Kinded Types (HKTs) and Optcs in Java with the Higher-Kinded-J library. Learn about Functors, Applicatives, Monads, Transformers, practical functional patterns, and how to write cleaner, more composable Java code for your projects using Optics.">


        <meta name="keywords" content="Higher-Kinded Types, Higher-Kinded-J, Higher-Kinded Java, Higher Kinded Java, HKT, Java, Optics, Lens, Prism, Traversal, Iso, Functional Programming, Monad, Functor, Applicative, Transformer, Monoid, Traverse, higherkindedj">
        
        <meta property="og:title" content="For Comprehension - Higher-Kinded Types and Optics for Java"> 
            <meta property="og:description" content="Explore Higher-Kinded Types (HKTs) and Optcs in Java with the Higher-Kinded-J library. Learn about Functors, Applicatives, Monads, Transformers, practical functional patterns, and how to write cleaner, more composable Java code for your projects using Optics.">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://higher-kinded-j.github.io/"> 
        
        <meta property="og:image" content="https://higher-kinded-j.github.io/preview.png" />
        <meta property="og:site_name" content="Higher-Kinded-J Documentation" />
        
        
        <meta name="twitter:card" content="summary_large_image" /> <meta name="twitter:title" content="For Comprehension - Higher-Kinded Types and Optics for Java - Higher-Kinded-J" />
        <meta name="twitter:description" content="Bringing Higher-Kinded Types and Optics to Java functional patterns" />
        <meta name="twitter:image" content="https://higher-kinded-j.github.io/preview.png" />
        <meta name="description" content="Explore Higher-Kinded Types (HKTs) and Optcs in Java with the Higher-Kinded-J library. Learn about Functors, Applicatives, Monads, Transformers, practical functional patterns, and how to write cleaner, more composable Java code for your projects using Optics.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">
        <meta name="google-site-verification" content="X-xsiAq2cKMLOzh9dexUrX8Onx2h_YMUFgp5lHHUwSg" />
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin.css">
        <link rel="stylesheet" href=".././theme/catppuccin-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin-alerts.css">
        <link rel="stylesheet" href=".././theme/additional-hkj.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "latte";
            const default_dark_theme = "macchiato";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('latte')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frappé</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        <div class="version-selector-container">
                            <select id="version-selector" class="version-selector" aria-label="Select documentation version" title="Select documentation version">
                                <option value="">Loading versions...</option>
                            </select>
                        </div>
                    </div>

                    <h1 class="menu-title">Higher-Kinded Types and Optics for Java</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j/edit/main/hkj-book/src/functional/for_comprehension.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="for-comprehensions"><a class="header" href="#for-comprehensions">For-Comprehensions</a></h1>
<div id="admonition-what-youll-learn" class="admonition admonish-info" role="note" aria-labelledby="admonition-what-youll-learn-title">
<div class="admonition-title">
<div id="admonition-what-youll-learn-title">
<p>What You'll Learn</p>
</div>
<a class="admonition-anchor-link" href="#admonition-what-youll-learn"></a>
</div>
<div>
<ul>
<li>How to transform nested <code>flatMap</code> chains into readable, sequential code</li>
<li>The four types of operations: generators (<code>.from()</code>), bindings (<code>.let()</code>), guards (<code>.when()</code>), and projections (<code>.yield()</code>)</li>
<li>Building complex workflows with StateT and other monad transformers</li>
<li>Converting "pyramid of doom" code into clean, imperative-style scripts</li>
<li>Real-world examples from simple Maybe operations to complex state management</li>
</ul>
</div>
</div>
<div id="admonition-see-example-code" class="admonition admonish-example" role="note" aria-labelledby="admonition-see-example-code-title">
<div class="admonition-title">
<div id="admonition-see-example-code-title">
<p>See Example Code:</p>
</div>
<a class="admonition-anchor-link" href="#admonition-see-example-code"></a>
</div>
<div>
<p><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/basic/expression/ForComprehensionExample.java">ForComprehensionExample.java</a></p>
</div>
</div>
<p>Endless nested callbacks and unreadable chains of flatMap calls can be tiresome. The <code>higher-kinded-j</code> library brings the elegance and power of Scala-style for-comprehensions to Java, allowing you to write complex asynchronous and sequential logic in a way that is clean, declarative, and easy to follow.</p>
<p>Let's see how to transform "callback hell" into a readable, sequential script.</p>
<h2 id="the-pyramid-of-doom-problem"><a class="header" href="#the-pyramid-of-doom-problem">The "Pyramid of Doom" Problem</a></h2>
<p>In functional programming, monads are a powerful tool for sequencing operations, especially those with a context like <code>Optional</code>, <code>List</code>, or <code>CompletableFuture</code>. However, chaining these operations with <code>flatMap</code> can quickly become hard to read.</p>
<p>Consider combining three <code>Maybe</code> values:</p>
<pre><code class="language-java">// The "nested" way
Kind&lt;MaybeKind.Witness, Integer&gt; result = maybeMonad.flatMap(a -&gt;
    maybeMonad.flatMap(b -&gt;
        maybeMonad.map(c -&gt; a + b + c, maybeC),
    maybeB),
maybeA);
</code></pre>
<p>This code works, but the logic is buried inside nested lambdas. The intent (to simply get values from <code>maybeA</code>, <code>maybeB</code>, and <code>maybeC</code> and add them) is obscured. This is often called the "pyramid of doom."</p>
<h2 id="for-a-fluent-sequential-builder"><a class="header" href="#for-a-fluent-sequential-builder"><em>For</em> A Fluent, Sequential Builder</a></h2>
<p>The <code>For</code> comprehension builder provides a much more intuitive way to write the same logic. It lets you express the sequence of operations as if they were simple, imperative steps.</p>
<p>Here’s the same example rewritten with the <code>For</code> builder:</p>
<pre><code class="language-java">import static org.higherkindedj.hkt.maybe.MaybeKindHelper.MAYBE;
import org.higherkindedj.hkt.expression.For;
// ... other imports

var maybeMonad = MaybeMonad.INSTANCE;
var maybeA = MAYBE.just(5);
var maybeB = MAYBE.just(10);
var maybeC = MAYBE.just(20);

// The clean, sequential way
var result = For.from(maybeMonad, maybeA)    // Get a from maybeA
    .from(a -&gt; maybeB)                       // Then, get b from maybeB
    .from(t -&gt; maybeC)                       // Then, get c from maybeC
    .yield((a, b, c) -&gt; a + b + c);          // Finally, combine them

System.out.println(MAYBE.narrow(result)); // Prints: Just(35)
</code></pre>
<p>This version is flat, readable, and directly expresses the intended sequence of operations. The <code>For</code> builder automatically handles the <code>flatMap</code> and <code>map</code> calls behind the scenes.</p>
<h2 id="core-operations-of-the-for-builder"><a class="header" href="#core-operations-of-the-for-builder">Core Operations of the <code>For</code> Builder</a></h2>
<p>A for-comprehension is built by chaining four types of operations:</p>
<h3 id="1-generators-from"><a class="header" href="#1-generators-from">1. Generators: <code>.from()</code></a></h3>
<p>A generator is the workhorse of the comprehension. It takes a value from a previous step, uses it to produce a new monadic value (like another <code>Maybe</code> or <code>List</code>), and extracts the result for the next step. This is a direct equivalent of <strong><code>flatMap</code></strong>.</p>
<p>Each <code>.from()</code> adds a new variable to the scope of the comprehension.</p>
<pre><code class="language-java">// Generates all combinations of userLogin IDs and roles
var userRoles = For.from(listMonad, LIST.widen(List.of("userLogin-1", "userLogin-2"))) // a: "userLogin-1", "userLogin-2"
    .from(a -&gt; LIST.widen(List.of("viewer", "editor")))       // b: "viewer", "editor"
    .yield((a, b) -&gt; a + " is a " + b);

// Result: ["userLogin-1 is a viewer", "userLogin-1 is a editor", "userLogin-2 is a viewer", "userLogin-2 is a editor"]
</code></pre>
<h3 id="2-value-bindings-let"><a class="header" href="#2-value-bindings-let">2. Value Bindings: <code>.let()</code></a></h3>
<p>A <code>.let()</code> binding allows you to compute a pure, simple value from the results you've gathered so far and add it to the scope. It does <em>not</em> involve a monad. This is equivalent to a <strong><code>map</code></strong> operation that carries the new value forward.</p>
<pre><code class="language-java">var idMonad = IdMonad.instance();

var result = For.from(idMonad, Id.of(10))        // a = 10
    .let(a -&gt; a * 2)                          // b = 20 (a pure calculation)
    .yield((a, b) -&gt; "Value: " + a + ", Doubled: " + b);

// Result: "Value: 10, Doubled: 20"
System.out.println(ID.unwrap(result));
</code></pre>
<h3 id="3-guards-when"><a class="header" href="#3-guards-when">3. Guards: <code>.when()</code></a></h3>
<p>For monads that can represent failure or emptiness (like <code>List</code>, <code>Maybe</code>, or <code>Optional</code>), you can use <code>.when()</code> to <strong>filter</strong> results. If the condition is false, the current computational path is stopped by returning the monad's "zero" value (e.g., an empty list or <code>Maybe.nothing()</code>).</p>
<blockquote>
<p>This feature requires a <code>MonadZero</code> instance. See the <code>MonadZero</code> documentation for more details.</p>
</blockquote>
<pre><code class="language-java">var evens = For.from(listMonad, LIST.widen(List.of(1, 2, 3, 4, 5, 6)))
    .when(i -&gt; i % 2 == 0) // Guard: only keep even numbers
    .yield(i -&gt; i);

// Result: [2, 4, 6]
</code></pre>
<h3 id="4-projection-yield"><a class="header" href="#4-projection-yield">4. Projection: <code>.yield()</code></a></h3>
<p>Every comprehension ends with <code>.yield()</code>. This is the final <strong><code>map</code></strong> operation where you take all the values you've gathered from the generators and bindings and produce your final result. You can access the bound values as individual lambda parameters or as a single <code>Tuple</code>.</p>
<h2 id="turn-the-power-up-statet-example"><a class="header" href="#turn-the-power-up-statet-example">Turn the power up: <code>StateT</code> Example</a></h2>
<ul>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/basic/expression/ForComprehensionExample.java">ForComprehensionExample.java</a></li>
</ul>
<p>The true power of for-comprehensions becomes apparent when working with complex structures like monad transformers. A <code>StateT</code> over <code>Optional</code> represents a <strong>stateful computation that can fail</strong>. Writing this with nested <code>flatMap</code> calls would be extremely complex. With the <code>For</code> builder, it becomes a simple, readable script.</p>
<pre><code class="language-java">import static org.higherkindedj.hkt.optional.OptionalKindHelper.OPTIONAL;
import static org.higherkindedj.hkt.state_t.StateTKindHelper.STATE_T;
// ... other imports

private static void stateTExample() {
    final var optionalMonad = OptionalMonad.INSTANCE;
    final var stateTMonad = StateTMonad.&lt;Integer, OptionalKind.Witness&gt;instance(optionalMonad);

    // Helper: adds a value to the state (an integer)
    final Function&lt;Integer, Kind&lt;StateTKind.Witness&lt;Integer, OptionalKind.Witness&gt;, Unit&gt;&gt; add =
        n -&gt; StateT.create(s -&gt; optionalMonad.of(StateTuple.of(s + n, Unit.INSTANCE)), optionalMonad);

    // Helper: gets the current state as the value
    final var get = StateT.&lt;Integer, OptionalKind.Witness, Integer&gt;create(s -&gt; optionalMonad.of(StateTuple.of(s, s)), optionalMonad);

    // This workflow looks like a simple script, but it's a fully-typed, purely functional composition!
    final var statefulComputation =
        For.from(stateTMonad, add.apply(10))      // Add 10 to state
            .from(a -&gt; add.apply(5))              // Then, add 5 more
            .from(b -&gt; get)                       // Then, get the current state (15)
            .let(t -&gt; "The state is " + t._3())   // Compute a string from it
            .yield((a, b, c, d) -&gt; d + ", original value was " + c); // Produce the final string

    // Run the computation with an initial state of 0
    final var resultOptional = STATE_T.runStateT(statefulComputation, 0);
    final Optional&lt;StateTuple&lt;Integer, String&gt;&gt; result = OPTIONAL.narrow(resultOptional);

    result.ifPresent(res -&gt; {
        System.out.println("Final value: " + res.value());
        System.out.println("Final state: " + res.state());
    });
    // Expected Output:
    // Final value: The state is 15, original value was 15
    // Final state: 15
}
</code></pre>
<p>In this example, Using the <code>For</code> comprehension really helps hide the complexity of threading the state (<code>Integer</code>) and handling potential failures (<code>Optional</code>), making the logic clear and maintainable.</p>
<p>For a more extensive example of using the full power of the For comprehension head over to the <a href="../hkts/order-walkthrough.html">Order Workflow</a></p>
<h2 id="similarities-to-scala"><a class="header" href="#similarities-to-scala">Similarities to Scala</a></h2>
<p>If you're familiar with Scala, you'll recognise the pattern. In Scala, a for-comprehension looks like this:</p>
<pre><code class="language-scala">for {
 a &lt;- maybeA
 b &lt;- maybeB
 if (a + b &gt; 10)
 c = a + b
} yield c * 2
</code></pre>
<p>This is built in syntactic sugar that the compiler translates into a series of <code>flatMap</code>, <code>map</code>, and <code>withFilter</code> calls.
The <code>For</code> builder in <code>higher-kinded-j</code> provides the same expressive power through a method-chaining API.</p>
<hr />
<h2 id="working-with-optics"><a class="header" href="#working-with-optics">Working with Optics</a></h2>
<div id="admonition-for-optics-integration" class="admonition admonish-info" role="note" aria-labelledby="admonition-for-optics-integration-title">
<div class="admonition-title">
<div id="admonition-for-optics-integration-title">
<p>For-Optics Integration</p>
</div>
<a class="admonition-anchor-link" href="#admonition-for-optics-integration"></a>
</div>
<div>
<p>The For comprehension integrates natively with the <a href="../optics/optics_intro.html">Optics</a> library, providing first-class support for lens-based extraction, prism-based pattern matching, and traversal-based iteration within monadic comprehensions.</p>
</div>
</div>
<p>The <code>For</code> builder provides two optic-aware operations that extend the comprehension capabilities:</p>
<h3 id="extracting-values-with-focus"><a class="header" href="#extracting-values-with-focus">Extracting Values with <code>focus()</code></a></h3>
<p>The <code>focus()</code> method extracts a value using a function and adds it to the accumulated tuple. This is particularly useful when working with nested data structures.</p>
<pre><code class="language-java">record User(String name, Address address) {}
record Address(String city, String street) {}

var users = List.of(
    new User("Alice", new Address("London", "Baker St")),
    new User("Bob", new Address("Paris", "Champs-Élysées"))
);

Kind&lt;ListKind.Witness, String&gt; result =
    For.from(listMonad, LIST.widen(users))
        .focus(user -&gt; user.address().city())
        .yield((user, city) -&gt; user.name() + " lives in " + city);

// Result: ["Alice lives in London", "Bob lives in Paris"]
</code></pre>
<p>The extracted value is accumulated alongside the original value, making both available in subsequent steps and in the final <code>yield()</code>.</p>
<h3 id="pattern-matching-with-match"><a class="header" href="#pattern-matching-with-match">Pattern Matching with <code>match()</code></a></h3>
<p>The <code>match()</code> method provides prism-like pattern matching within comprehensions. When used with a <code>MonadZero</code> (such as <code>List</code> or <code>Maybe</code>), it short-circuits the computation if the match fails.</p>
<pre><code class="language-java">sealed interface Result permits Success, Failure {}
record Success(String value) implements Result {}
record Failure(String error) implements Result {}

Prism&lt;Result, Success&gt; successPrism = Prism.of(
    r -&gt; r instanceof Success s ? Optional.of(s) : Optional.empty(),
    s -&gt; s
);

List&lt;Result&gt; results = List.of(
    new Success("data1"),
    new Failure("error"),
    new Success("data2")
);

Kind&lt;ListKind.Witness, String&gt; successes =
    For.from(listMonad, LIST.widen(results))
        .match(successPrism)
        .yield((result, success) -&gt; success.value().toUpperCase());

// Result: ["DATA1", "DATA2"] - failures are filtered out
</code></pre>
<p>With <code>Maybe</code>, failed matches short-circuit to <code>Nothing</code>:</p>
<pre><code class="language-java">Kind&lt;MaybeKind.Witness, String&gt; result =
    For.from(maybeMonad, MAYBE.just((Result) new Failure("error")))
        .match(successPrism)
        .yield((r, s) -&gt; s.value());

// Result: Nothing - the match failed
</code></pre>
<div id="admonition-combining-focus-and-match" class="admonition admonish-tip" role="note" aria-labelledby="admonition-combining-focus-and-match-title">
<div class="admonition-title">
<div id="admonition-combining-focus-and-match-title">
<p>Combining focus() and match()</p>
</div>
<a class="admonition-anchor-link" href="#admonition-combining-focus-and-match"></a>
</div>
<div>
<p>Both operations can be chained to build complex extraction and filtering pipelines:</p>
<pre><code class="language-java">For.from(listMonad, LIST.widen(items))
    .focus(item -&gt; item.category())
    .match(premiumCategoryPrism)
    .when(t -&gt; t._3().discount() &gt; 0.1)
    .yield((item, category, premium) -&gt; item.name());
</code></pre>
</div>
</div>
<hr />
<h2 id="bulk-operations-with-fortraversal"><a class="header" href="#bulk-operations-with-fortraversal">Bulk Operations with ForTraversal</a></h2>
<p>For operations over multiple elements within a structure, use <code>ForTraversal</code>. This provides a fluent API for applying transformations to all elements focused by a <a href="../optics/traversals.html">Traversal</a>.</p>
<pre><code class="language-java">record Player(String name, int score) {}

List&lt;Player&gt; players = List.of(
    new Player("Alice", 100),
    new Player("Bob", 200)
);

Traversal&lt;List&lt;Player&gt;, Player&gt; playersTraversal = Traversals.forList();
Lens&lt;Player, Integer&gt; scoreLens = Lens.of(
    Player::score,
    (p, s) -&gt; new Player(p.name(), s)
);

// Add bonus points to all players
Kind&lt;IdKind.Witness, List&lt;Player&gt;&gt; result =
    ForTraversal.over(playersTraversal, players, IdMonad.instance())
        .modify(scoreLens, score -&gt; score + 50)
        .run();

List&lt;Player&gt; updated = IdKindHelper.ID.unwrap(result);
// Result: [Player("Alice", 150), Player("Bob", 250)]
</code></pre>
<h3 id="filtering-within-traversals"><a class="header" href="#filtering-within-traversals">Filtering Within Traversals</a></h3>
<p>The <code>filter()</code> method preserves non-matching elements unchanged whilst applying transformations only to matching elements:</p>
<pre><code class="language-java">Kind&lt;IdKind.Witness, List&lt;Player&gt;&gt; result =
    ForTraversal.over(playersTraversal, players, IdMonad.instance())
        .filter(p -&gt; p.score() &gt;= 150)
        .modify(scoreLens, score -&gt; score * 2)
        .run();

// Alice (100) unchanged, Bob (200) doubled to 400
</code></pre>
<h3 id="collecting-results"><a class="header" href="#collecting-results">Collecting Results</a></h3>
<p>Use <code>toList()</code> to collect all focused elements:</p>
<pre><code class="language-java">Kind&lt;IdKind.Witness, List&lt;Player&gt;&gt; allPlayers =
    ForTraversal.over(playersTraversal, players, IdMonad.instance())
        .toList();
</code></pre>
<hr />
<h2 id="stateful-updates-with-forstate"><a class="header" href="#stateful-updates-with-forstate">Stateful Updates with ForState</a></h2>
<p><code>ForState</code> provides a fluent API for threading state updates through a workflow using lenses. This is particularly useful for building up complex state transformations step by step.</p>
<pre><code class="language-java">record WorkflowContext(
    String orderId,
    boolean validated,
    boolean inventoryChecked,
    String confirmationId
) {}

Lens&lt;WorkflowContext, Boolean&gt; validatedLens = Lens.of(
    WorkflowContext::validated,
    (ctx, v) -&gt; new WorkflowContext(ctx.orderId(), v, ctx.inventoryChecked(), ctx.confirmationId())
);

Lens&lt;WorkflowContext, Boolean&gt; inventoryLens = Lens.of(
    WorkflowContext::inventoryChecked,
    (ctx, c) -&gt; new WorkflowContext(ctx.orderId(), ctx.validated(), c, ctx.confirmationId())
);

Lens&lt;WorkflowContext, String&gt; confirmationLens = Lens.of(
    WorkflowContext::confirmationId,
    (ctx, id) -&gt; new WorkflowContext(ctx.orderId(), ctx.validated(), ctx.inventoryChecked(), id)
);

var initialContext = new WorkflowContext("ORD-123", false, false, null);

Kind&lt;IdKind.Witness, WorkflowContext&gt; result =
    ForState.withState(idMonad, Id.of(initialContext))
        .update(validatedLens, true)
        .update(inventoryLens, true)
        .update(confirmationLens, "CONF-456")
        .yield();

WorkflowContext finalCtx = IdKindHelper.ID.unwrap(result);
// finalCtx: validated=true, inventoryChecked=true, confirmationId="CONF-456"
</code></pre>
<h3 id="modifying-state-based-on-current-values"><a class="header" href="#modifying-state-based-on-current-values">Modifying State Based on Current Values</a></h3>
<p>Use <code>modify()</code> to update state based on the current value:</p>
<pre><code class="language-java">ForState.withState(idMonad, Id.of(context))
    .modify(scoreLens, score -&gt; score + bonus)
    .yield();
</code></pre>
<hr />
<h2 id="position-aware-traversals-with-forindexed"><a class="header" href="#position-aware-traversals-with-forindexed">Position-Aware Traversals with ForIndexed</a></h2>
<p><code>ForIndexed</code> extends traversal comprehensions to include index/position awareness, enabling transformations that depend on element position within the structure.</p>
<pre><code class="language-java">IndexedTraversal&lt;Integer, List&lt;Player&gt;, Player&gt; indexedPlayers =
    IndexedTraversals.forList();

List&lt;Player&gt; players = List.of(
    new Player("Alice", 100),
    new Player("Bob", 200),
    new Player("Charlie", 150)
);

// Add position-based bonus (first place gets more)
Kind&lt;IdKind.Witness, List&lt;Player&gt;&gt; result =
    ForIndexed.overIndexed(indexedPlayers, players, IdMonad.instance())
        .modify(scoreLens, (index, score) -&gt; score + (100 - index * 10))
        .run();

// Alice: 100 + 100 = 200
// Bob: 200 + 90 = 290
// Charlie: 150 + 80 = 230
</code></pre>
<h3 id="filtering-by-position"><a class="header" href="#filtering-by-position">Filtering by Position</a></h3>
<p>Use <code>filterIndex()</code> to focus only on specific positions:</p>
<pre><code class="language-java">// Only modify top 3 players
ForIndexed.overIndexed(indexedPlayers, players, idApplicative)
    .filterIndex(i -&gt; i &lt; 3)
    .modify(scoreLens, (i, s) -&gt; s * 2)
    .run();
</code></pre>
<h3 id="combined-index-and-value-filtering"><a class="header" href="#combined-index-and-value-filtering">Combined Index and Value Filtering</a></h3>
<p>Use <code>filter()</code> with a <code>BiPredicate</code> to filter based on both position and value:</p>
<pre><code class="language-java">ForIndexed.overIndexed(indexedPlayers, players, idApplicative)
    .filter((index, player) -&gt; index &lt; 5 &amp;&amp; player.score() &gt; 100)
    .modify(scoreLens, (i, s) -&gt; s + 50)
    .run();
</code></pre>
<h3 id="collecting-with-indices"><a class="header" href="#collecting-with-indices">Collecting with Indices</a></h3>
<p>Use <code>toIndexedList()</code> to collect elements along with their indices:</p>
<pre><code class="language-java">Kind&lt;IdKind.Witness, List&lt;Pair&lt;Integer, Player&gt;&gt;&gt; indexed =
    ForIndexed.overIndexed(indexedPlayers, players, idApplicative)
        .toIndexedList();

// Result: [Pair(0, Player("Alice", 100)), Pair(1, Player("Bob", 200)), ...]
</code></pre>
<div id="admonition-see-also" class="admonition admonish-tip" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See Also</p>
</div>
<a class="admonition-anchor-link" href="#admonition-see-also"></a>
</div>
<div>
<p>For more details on indexed optics, see <a href="../optics/indexed_optics.html">Indexed Optics</a>.</p>
</div>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../functional/natural_transformation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../monads/ch_intro.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../functional/natural_transformation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../monads/ch_intro.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../version-switcher.js"></script>
        <script src=".././theme/version-switcher.js"></script>


    </div>
    </body>
</html>
