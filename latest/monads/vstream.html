<!DOCTYPE HTML>
<html lang="en" class="latte sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>VStream - Higher-Kinded-J: Composable Effects and Advanced Optics for Java</title>


        <!-- Custom HTML head -->


            <meta name="description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">


        <meta name="keywords" content="Higher-Kinded Types, Higher-Kinded-J, HKT, Java, Optics, Lens, Prism, Traversal, Iso, Affine, Focus DSL, Effect Path API, Functional Programming, Monad, Functor, Applicative, EitherPath, MaybePath, TryPath, ValidationPath, Java Records, Sealed Interface, Error Handling, Immutable Data">
        
        <meta property="og:title" content="VStream - Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
            <meta property="og:description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://higher-kinded-j.github.io/">
        <meta property="og:image" content="https://higher-kinded-j.github.io/preview.png">
        <meta property="og:image:width" content="1200">
        <meta property="og:image:height" content="630">
        <meta property="og:site_name" content="Higher-Kinded-J Documentation">
        <meta property="og:locale" content="en_GB">
        
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="VStream - Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
        <meta name="twitter:description" content="Unifying Composable Effects and Advanced Optics for Java. Effect Path API, Focus DSL, and the most comprehensive optics implementation in the Java ecosystem.">
        <meta name="twitter:image" content="https://higher-kinded-j.github.io/preview.png">
        <meta name="twitter:image:alt" content="Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
        <meta name="description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">
        <meta name="google-site-verification" content="X-xsiAq2cKMLOzh9dexUrX8Onx2h_YMUFgp5lHHUwSg" />
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin.css">
        <link rel="stylesheet" href=".././theme/catppuccin-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin-alerts.css">
        <link rel="stylesheet" href=".././theme/additional-hkj.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "latte";
            const default_dark_theme = "macchiato";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('latte')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frappé</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        <div class="version-selector-container">
                            <select id="version-selector" class="version-selector" aria-label="Select documentation version" title="Select documentation version">
                                <option value="">Loading versions...</option>
                            </select>
                        </div>
                    </div>

                    <h1 class="menu-title">Higher-Kinded-J: Composable Effects and Advanced Optics for Java</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j/edit/main/hkj-book/src/monads/vstream.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="vstream-lazy-pull-based-streaming-on-virtual-threads"><a class="header" href="#vstream-lazy-pull-based-streaming-on-virtual-threads">VStream: Lazy Pull-Based Streaming on Virtual Threads</a></h1>
<h2 id="consumer-driven-pipelines-that-wait-until-youre-ready"><a class="header" href="#consumer-driven-pipelines-that-wait-until-youre-ready"><em>Consumer-Driven Pipelines That Wait Until You're Ready</em></a></h2>
<div id="admonition-what-youll-learn" class="admonition admonish-info" role="note" aria-labelledby="admonition-what-youll-learn-title">
<div class="admonition-title">
<div id="admonition-what-youll-learn-title">
<p>What You'll Learn</p>
</div>
<a class="admonition-anchor-link" href="#admonition-what-youll-learn"></a>
</div>
<div>
<ul>
<li>How VStream provides lazy, pull-based streaming with virtual thread execution</li>
<li>The Step protocol: Emit, Done, and Skip</li>
<li>Factory methods for creating streams from various sources</li>
<li>Transformation combinators: map, flatMap, filter, take</li>
<li>Terminal operations: toList, fold, exists, find</li>
<li>Error handling and recovery patterns</li>
<li>How VStream compares to Java Stream and StreamPath</li>
</ul>
</div>
</div>
<blockquote>
<p><em>"Tape after tape. You don't get the whole story at once. You pull the next one, press play, and hope you're ready for what comes out."</em>
— <strong>Dan Powell</strong>, <em>Archive 81</em></p>
</blockquote>
<div id="admonition-see-example-code" class="admonition admonish-example" role="note" aria-labelledby="admonition-see-example-code-title">
<div class="admonition-title">
<div id="admonition-see-example-code-title">
<p>See Example Code</p>
</div>
<a class="admonition-anchor-link" href="#admonition-see-example-code"></a>
</div>
<div>
<p><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/basic/vstream/VStreamBasicExample.java">VStreamBasicExample.java</a></p>
</div>
</div>
<h2 id="the-problem-streams-that-wont-wait"><a class="header" href="#the-problem-streams-that-wont-wait">The Problem: Streams That Won't Wait</a></h2>
<p>Dan Powell's archive is a pull-based stream: no tape plays itself, nothing advances until
he reaches for the next cassette. Java's <code>Stream</code> works the other way around. It pushes
elements whether you are ready or not, blocks a platform thread on every I/O call, and
falls apart the moment the data source is infinite or each element costs a network
round-trip. Once the pipeline starts, the consumer has no way to slow it down.</p>
<p>That eager-push model creates real problems. A paginated API that returns thousands of
pages will eagerly fetch all of them, even if the caller only needs the first ten. A
sensor feed that never ends will blow up any terminal operation that tries to collect
results. And because each blocked <code>Stream</code> operation pins a platform thread, scaling to
thousands of concurrent streams means thousands of expensive OS threads sitting idle
while they wait for data.</p>
<h2 id="the-solution-pull-one-element-at-a-time"><a class="header" href="#the-solution-pull-one-element-at-a-time">The Solution: Pull One Element at a Time</a></h2>
<p><code>VStream&lt;A&gt;</code> works like Dan's archive. Each pull returns a <code>VTask&lt;Step&lt;A&gt;&gt;</code>, a single
element produced lazily on a virtual thread. The consumer controls the pace. The stream
waits. Infinite sequences, paginated APIs, slow upstream services: none of these are a
problem when you only process one element at a time and the thread model scales to
millions of concurrent tasks.</p>
<pre><code>  Push Model (Java Stream)              Pull Model (VStream)
  ========================              =====================

  ┌────────┐         ┌──────────┐      ┌──────────┐         ┌────────┐
  │ Source │ ──▶──▶─▶│ Consumer │      │ Consumer │◀────────│ Source │
  └────────┘         └──────────┘      └─────┬────┘         └────────┘
                                             │ pull()            ▲
  Source drives the pace.                    ▼                   │
  Consumer must keep up.              VTask&lt;Step&lt;A&gt;&gt;        one element
  Blocks a platform thread.           (virtual thread)     at a time
  No backpressure.
                                       Consumer drives the pace.
                                       One virtual thread per pull.
                                       Natural backpressure.
</code></pre>
<p><strong>Package</strong>: <code>org.higherkindedj.hkt.vstream</code>
<strong>Module</strong>: <code>hkj-core</code></p>
<hr />
<h2 id="the-pull-protocol-step"><a class="header" href="#the-pull-protocol-step">The Pull Protocol: Step</a></h2>
<p>Every pull from a VStream answers exactly one question: <em>what happened when I asked for the next element?</em> The answer is always one of three cases, represented by the <code>Step&lt;A&gt;</code> sealed interface:</p>
<pre><code class="language-java">sealed interface Step&lt;A&gt; {
    record Emit&lt;A&gt;(@Nullable A value, VStream&lt;A&gt; tail) implements Step&lt;A&gt; {}
    record Done&lt;A&gt;()                                    implements Step&lt;A&gt; {}
    record Skip&lt;A&gt;(VStream&lt;A&gt; tail)                     implements Step&lt;A&gt; {}
}
</code></pre>
<pre><code>                            pull()
                              │
                              ▼
                       ┌─────────────┐
                       │ VTask&lt;Step&gt; │  (runs on virtual thread)
                       └──────┬──────┘
                              │
           ┌──────────────────┼──────────────────┐
           │                  │                  │
           ▼                  ▼                  ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │    Emit     │    │    Skip     │    │    Done     │
    │ value, tail │    │    tail     │    │             │
    └──────┬──────┘    └──────┬──────┘    └─────────────┘
           │                  │                  │
           ▼                  ▼                  ▼
      Yield value,       Advance to          Stream
      continue from      tail (zero          exhausted,
      tail               allocation)         stop pulling
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Step</th><th>Meaning</th></tr></thead><tbody>
<tr><td><code>Emit(value, tail)</code></td><td>Here is a value, and here is the rest of the stream</td></tr>
<tr><td><code>Done()</code></td><td>The stream is exhausted; stop pulling</td></tr>
<tr><td><code>Skip(tail)</code></td><td>No value this time (e.g. filtered out); advance to the tail</td></tr>
</tbody></table>
</div>
<p>Why <code>Skip</code>? Consider a <code>filter</code> that rejects 90% of elements. Without <code>Skip</code>, the stream would need to allocate and discard wrapper objects for every rejected element. <code>Skip</code> short-circuits that: the pipeline simply advances to the next pull without producing anything, keeping memory allocation tight.</p>
<hr />
<h2 id="where-does-your-data-come-from"><a class="header" href="#where-does-your-data-come-from">Where Does Your Data Come From?</a></h2>
<p>VStream provides factory methods that cover the most common sources. All of them are lazy: nothing is produced until a terminal operation triggers evaluation.</p>
<h3 id="from-values-you-already-have"><a class="header" href="#from-values-you-already-have">From Values You Already Have</a></h3>
<pre><code class="language-java">// Single element
VStream&lt;String&gt; single = VStream.of("hello");

// Multiple elements (varargs)
VStream&lt;Integer&gt; numbers = VStream.of(1, 2, 3, 4, 5);

// From an existing list (lazy; does not copy)
VStream&lt;String&gt; fromList = VStream.fromList(List.of("a", "b", "c"));

// Integer range [start, end)
VStream&lt;Integer&gt; range = VStream.range(1, 6); // 1, 2, 3, 4, 5

// Empty stream
VStream&lt;Integer&gt; empty = VStream.empty();
</code></pre>
<h3 id="from-sequences-that-never-end"><a class="header" href="#from-sequences-that-never-end">From Sequences That Never End</a></h3>
<p>The pull model means infinite sources are perfectly safe. The consumer decides when to stop.</p>
<pre><code class="language-java">// Infinite sequence from seed and step function
VStream&lt;Integer&gt; powersOf2 = VStream.iterate(1, n -&gt; n * 2);
// 1, 2, 4, 8, 16, 32, ...

// Infinite sequence from supplier
VStream&lt;Double&gt; randoms = VStream.generate(Math::random);

// Infinite repetition of a single value
VStream&lt;String&gt; hellos = VStream.repeat("hello");
</code></pre>
<div id="admonition-infinite-streams" class="admonition admonish-warning" role="note" aria-labelledby="admonition-infinite-streams-title">
<div class="admonition-title">
<div id="admonition-infinite-streams-title">
<p>Infinite Streams</p>
</div>
<a class="admonition-anchor-link" href="#admonition-infinite-streams"></a>
</div>
<div>
<p>Infinite streams require a limiting operation such as <code>take()</code> or <code>takeWhile()</code> before
any terminal operation that consumes all elements (like <code>toList()</code> or <code>fold()</code>).
Short-circuiting terminal operations like <code>exists()</code> and <code>find()</code> are safe to use
directly on infinite streams.</p>
</div>
</div>
<h3 id="from-effectful-sources-paginated-apis-databases-etc"><a class="header" href="#from-effectful-sources-paginated-apis-databases-etc">From Effectful Sources (Paginated APIs, Databases, etc.)</a></h3>
<p>This is where VStream really separates itself from Java <code>Stream</code>. The <code>unfold()</code> factory
creates a stream by repeatedly applying an effectful function to a state, producing
elements until <code>Optional.empty()</code> signals the end. Each step runs inside a <code>VTask</code>, so
network calls, database queries, and file reads all happen on virtual threads without
blocking the caller.</p>
<pre><code class="language-java">// Paginated API: fetch pages until the server says "no more"
VStream&lt;String&gt; pages = VStream.unfold(1, page -&gt;
    VTask.of(() -&gt; {
        if (page &gt; 3) return Optional.empty();
        String data = fetchPage(page);
        return Optional.of(new VStream.Seed&lt;&gt;(data, page + 1));
    }));
</code></pre>
<p>The <code>Seed&lt;A, S&gt;</code> record carries both the emitted value and the next state:</p>
<pre><code class="language-java">public record Seed&lt;A, S&gt;(@Nullable A value, S next) {}
</code></pre>
<p>Each call to the unfold function advances the state and either emits a value or signals completion:</p>
<pre><code>  unfold(1, fetchPage)

  State: 1 ──▶ fetchPage(1) ──▶ Seed("page1", 2) ──▶ Emit("page1")
  State: 2 ──▶ fetchPage(2) ──▶ Seed("page2", 3) ──▶ Emit("page2")
  State: 3 ──▶ fetchPage(3) ──▶ Seed("page3", 4) ──▶ Emit("page3")
  State: 4 ──▶ fetchPage(4) ──▶ Optional.empty()  ──▶ Done
</code></pre>
<hr />
<h2 id="shaping-the-data-you-need"><a class="header" href="#shaping-the-data-you-need">Shaping the Data You Need</a></h2>
<p>All transformation operations are lazy. They describe a new pipeline without producing any elements. No work happens until a terminal operation pulls through the chain.</p>
<h3 id="map"><a class="header" href="#map">map</a></h3>
<p>Transform each element:</p>
<pre><code class="language-java">List&lt;String&gt; result = VStream.of(1, 2, 3)
    .map(n -&gt; "#" + n)
    .toList().run();
// ["#1", "#2", "#3"]
</code></pre>
<h3 id="filter"><a class="header" href="#filter">filter</a></h3>
<p>Keep only elements matching a predicate. Rejected elements produce a <code>Skip</code> step internally, avoiding unnecessary allocation:</p>
<pre><code class="language-java">List&lt;Integer&gt; evens = VStream.range(1, 11)
    .filter(n -&gt; n % 2 == 0)
    .toList().run();
// [2, 4, 6, 8, 10]
</code></pre>
<h3 id="flatmap"><a class="header" href="#flatmap">flatMap</a></h3>
<p>Replace each element with a sub-stream and flatten the results. This is the monadic
bind operation for VStream:</p>
<pre><code class="language-java">List&lt;Integer&gt; result = VStream.of(1, 2, 3)
    .flatMap(n -&gt; VStream.of(n, n * 10))
    .toList().run();
// [1, 10, 2, 20, 3, 30]
</code></pre>
<p>The <code>via()</code> method is an alias for <code>flatMap</code>, consistent with the FocusDSL vocabulary.</p>
<h3 id="take-and-takewhile"><a class="header" href="#take-and-takewhile">take and takeWhile</a></h3>
<p>These operations give the consumer explicit control over how much data to pull. They are the safety valve for infinite streams.</p>
<pre><code class="language-java">// First 5 elements of an infinite stream
List&lt;Integer&gt; first5 = VStream.iterate(1, n -&gt; n + 1)
    .take(5).toList().run();
// [1, 2, 3, 4, 5]

// Elements while condition holds
List&lt;Integer&gt; small = VStream.iterate(1, n -&gt; n * 2)
    .takeWhile(n -&gt; n &lt; 100).toList().run();
// [1, 2, 4, 8, 16, 32, 64]
</code></pre>
<h3 id="composing-pipelines"><a class="header" href="#composing-pipelines">Composing Pipelines</a></h3>
<p>Operations chain naturally into lazy pipelines. Each stage pulls from the previous one, and the entire chain processes elements one at a time. The consumer (on the left) drives everything:</p>
<pre><code>  ┌──────────┐  pull  ┌─────────┐  pull  ┌────────┐  pull  ┌────────────┐  pull  ┌────────────┐
  │ toList() │◀───────│ take(5) │◀───────│ map(×3)│◀───────│filter(even)│◀───────│range(1,100)│
  └──────────┘        └─────────┘        └────────┘        └────────────┘        └────────────┘
       │                                                          │                     │
       │   range emits 1 ·········································· Skip (odd) ◀── Emit(1)
       │   range emits 2 ········· filter passes ·· Emit(2) ◀──── Emit(2)  ◀── Emit(2)
       │                           map: 2 × 3 = 6                 take: 1 of 5
       ◀── Emit(6) ◀── Emit(6) ◀─ Emit(6) ◀──────────────────────────────────────────────
       │
       │   ... continues until take has collected 5 elements, then stops.
       ▼
  [6, 12, 18, 24, 30]
</code></pre>
<pre><code class="language-java">List&lt;Integer&gt; result = VStream.range(1, 100)
    .filter(n -&gt; n % 2 == 0)   // keep evens
    .map(n -&gt; n * 3)            // multiply by 3
    .take(5)                    // first 5 results
    .toList().run();
// [6, 12, 18, 24, 30]
</code></pre>
<p>No element is produced until <code>toList().run()</code> triggers evaluation. The pipeline pulls only as many elements as needed, then stops.</p>
<hr />
<h2 id="collecting-results"><a class="header" href="#collecting-results">Collecting Results</a></h2>
<p>Terminal operations consume the stream and return a <code>VTask</code> that must be <code>run()</code> to
execute. All terminal operations use iterative loops for stack safety.</p>
<div class="table-wrapper"><table><thead><tr><th>Operation</th><th>Return Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>toList()</code></td><td><code>VTask&lt;List&lt;A&gt;&gt;</code></td><td>Collect all elements</td></tr>
<tr><td><code>fold(seed, op)</code></td><td><code>VTask&lt;A&gt;</code></td><td>Left fold with seed</td></tr>
<tr><td><code>foldLeft(seed, fn)</code></td><td><code>VTask&lt;B&gt;</code></td><td>Left fold with accumulator</td></tr>
<tr><td><code>headOption()</code></td><td><code>VTask&lt;Optional&lt;A&gt;&gt;</code></td><td>First element or empty</td></tr>
<tr><td><code>lastOption()</code></td><td><code>VTask&lt;Optional&lt;A&gt;&gt;</code></td><td>Last element or empty</td></tr>
<tr><td><code>count()</code></td><td><code>VTask&lt;Long&gt;</code></td><td>Count elements</td></tr>
<tr><td><code>exists(predicate)</code></td><td><code>VTask&lt;Boolean&gt;</code></td><td>Any match (short-circuits)</td></tr>
<tr><td><code>forAll(predicate)</code></td><td><code>VTask&lt;Boolean&gt;</code></td><td>All match (short-circuits)</td></tr>
<tr><td><code>find(predicate)</code></td><td><code>VTask&lt;Optional&lt;A&gt;&gt;</code></td><td>First matching element</td></tr>
<tr><td><code>forEach(consumer)</code></td><td><code>VTask&lt;Unit&gt;</code></td><td>Side effect per element</td></tr>
<tr><td><code>drain()</code></td><td><code>VTask&lt;Unit&gt;</code></td><td>Consume and discard all elements</td></tr>
</tbody></table>
</div>
<h3 id="fold-example"><a class="header" href="#fold-example">Fold Example</a></h3>
<pre><code class="language-java">Integer sum = VStream.of(1, 2, 3, 4, 5)
    .fold(0, Integer::sum).run();
// 15
</code></pre>
<h3 id="short-circuiting-stopping-early-on-infinite-streams"><a class="header" href="#short-circuiting-stopping-early-on-infinite-streams">Short-Circuiting: Stopping Early on Infinite Streams</a></h3>
<p><code>exists()</code> and <code>forAll()</code> stop pulling as soon as the result is determined. This makes
them safe even on infinite streams, because the pull model means the producer never runs
ahead of the consumer:</p>
<pre><code class="language-java">// Safe: stops as soon as 42 is found
Boolean found = VStream.iterate(0, n -&gt; n + 1)
    .exists(n -&gt; n == 42).run();
// true
</code></pre>
<hr />
<h2 id="merging-multiple-streams"><a class="header" href="#merging-multiple-streams">Merging Multiple Streams</a></h2>
<h3 id="concatenation"><a class="header" href="#concatenation">Concatenation</a></h3>
<p>Append one stream after another. The second stream is not touched until the first is exhausted:</p>
<pre><code class="language-java">VStream&lt;Integer&gt; combined = VStream.of(1, 2).concat(VStream.of(3, 4));
// [1, 2, 3, 4]
</code></pre>
<h3 id="zip"><a class="header" href="#zip">Zip</a></h3>
<p>Pair elements positionally. Stops at the shorter stream, so it is safe to zip a finite stream with an infinite one:</p>
<pre><code class="language-java">List&lt;String&gt; zipped = VStream.of("a", "b", "c")
    .zipWith(VStream.of(1, 2, 3), (s, n) -&gt; s + n)
    .toList().run();
// ["a1", "b2", "c3"]
</code></pre>
<h3 id="interleave"><a class="header" href="#interleave">Interleave</a></h3>
<p>Alternate elements from two streams:</p>
<pre><code class="language-java">List&lt;Integer&gt; interleaved = VStream.of(1, 3, 5)
    .interleave(VStream.of(2, 4, 6))
    .toList().run();
// [1, 2, 3, 4, 5, 6]
</code></pre>
<hr />
<h2 id="when-things-go-wrong"><a class="header" href="#when-things-go-wrong">When Things Go Wrong</a></h2>
<p>Real-world streams encounter failures: a network timeout on page 47, a malformed record in a CSV, a rate-limited API. VStream integrates with VTask's error model so that each individual pull can fail and recover independently, without tearing down the entire pipeline.</p>
<pre><code>  pull ──▶ VTask succeeds ──▶ Emit(value) ──▶ continue pulling
                                                       │
  pull ──▶ VTask fails ───────────────────────────────▶│
              │                                        │
              ├── recover(e -&gt; fallback)               │
              │      └──▶ Emit(fallback) ─────────────▶│
              │                                        │
              ├── recoverWith(e -&gt; altStream)          │
              │      └──▶ switch to altStream ────────▶│
              │                                        │
              └── no recovery                          │
                   └──▶ VTask propagates error         ▼
                                                   next pull
</code></pre>
<h3 id="recover"><a class="header" href="#recover">recover</a></h3>
<p>Replace a failed pull with a recovery value:</p>
<pre><code class="language-java">List&lt;String&gt; result = VStream.&lt;String&gt;fail(new RuntimeException("oops"))
    .recover(e -&gt; "recovered: " + e.getMessage())
    .toList().run();
// ["recovered: oops"]
</code></pre>
<h3 id="recoverwith"><a class="header" href="#recoverwith">recoverWith</a></h3>
<p>Replace a failed pull with a fallback stream:</p>
<pre><code class="language-java">List&lt;String&gt; result = VStream.&lt;String&gt;fail(new RuntimeException("primary failed"))
    .recoverWith(e -&gt; VStream.of("fallback-1", "fallback-2"))
    .toList().run();
// ["fallback-1", "fallback-2"]
</code></pre>
<h3 id="maperror"><a class="header" href="#maperror">mapError</a></h3>
<p>Transform errors without recovering, useful for wrapping low-level exceptions into domain-specific ones:</p>
<pre><code class="language-java">VStream&lt;String&gt; mapped = VStream.&lt;String&gt;fail(new RuntimeException("original"))
    .mapError(e -&gt; new IllegalStateException("wrapped: " + e.getMessage()));
</code></pre>
<div id="admonition-per-pull-recovery" class="admonition admonish-note" role="note" aria-labelledby="admonition-per-pull-recovery-title">
<div class="admonition-title">
<div id="admonition-per-pull-recovery-title">
<p>Per-Pull Recovery</p>
</div>
<a class="admonition-anchor-link" href="#admonition-per-pull-recovery"></a>
</div>
<div>
<p>Recovery applies per-pull, not per-stream. Each element pull can independently fail and
recover. After recovery, the stream continues from the recovery point.</p>
</div>
</div>
<hr />
<h2 id="proving-laziness-nothing-runs-until-you-say-so"><a class="header" href="#proving-laziness-nothing-runs-until-you-say-so">Proving Laziness: Nothing Runs Until You Say So</a></h2>
<p>If you are sceptical about lazy evaluation, here is the proof. Building a pipeline does
zero work. Only the terminal operation triggers element production:</p>
<pre><code class="language-java">AtomicInteger evaluations = new AtomicInteger(0);

// Pipeline construction: no elements produced yet
VStream&lt;Integer&gt; pipeline = VStream.generate(evaluations::incrementAndGet)
    .filter(n -&gt; n % 2 == 0)
    .map(n -&gt; n * 100)
    .take(5);

System.out.println(evaluations.get()); // 0

// Terminal operation triggers evaluation
List&lt;Integer&gt; result = pipeline.toList().run();
System.out.println(evaluations.get()); // 10 (pulled 10 to get 5 evens)
</code></pre>
<p>The counter stays at zero after pipeline construction. It only advances when <code>toList().run()</code> starts pulling, and it stops at exactly 10 because <code>take(5)</code> combined with a 50% filter pass rate means only 10 pulls are needed.</p>
<hr />
<h2 id="choosing-the-right-streaming-tool"><a class="header" href="#choosing-the-right-streaming-tool">Choosing the Right Streaming Tool</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Aspect</th><th>VStream</th><th>Java Stream</th><th>StreamPath</th></tr></thead><tbody>
<tr><td>Evaluation</td><td>Lazy, pull-based</td><td>Lazy, push-based</td><td>Eager (materialised list)</td></tr>
<tr><td>Execution</td><td>Virtual threads (VTask)</td><td>Platform threads</td><td>Synchronous</td></tr>
<tr><td>Reusability</td><td>Reusable</td><td>Single-use</td><td>Reusable</td></tr>
<tr><td>Infinite streams</td><td>Yes (take, takeWhile)</td><td>Yes (limit)</td><td>No</td></tr>
<tr><td>Error handling</td><td>recover, recoverWith</td><td>Exceptions</td><td>Via effect type</td></tr>
<tr><td>HKT integration</td><td>TBC</td><td>No</td><td>Yes</td></tr>
<tr><td>Effect composition</td><td>VTask per pull</td><td>None</td><td>Via Path API</td></tr>
</tbody></table>
</div>
<p><strong>Use VStream when</strong> you need lazy streaming with virtual thread execution, effectful
element production (e.g., paginated API calls), or infinite stream support with
backpressure through pull-based consumption.</p>
<p><strong>Use StreamPath when</strong> you have an already-materialised list and want fluent Path API
composition with optics integration.</p>
<p><strong>Use Java Stream when</strong> you need standard library compatibility and do not require
virtual thread integration or error recovery.</p>
<hr />
<div id="admonition-key-takeaways" class="admonition admonish-info" role="note" aria-labelledby="admonition-key-takeaways-title">
<div class="admonition-title">
<div id="admonition-key-takeaways-title">
<p>Key Takeaways</p>
</div>
<a class="admonition-anchor-link" href="#admonition-key-takeaways"></a>
</div>
<div>
<ul>
<li><strong>VStream is lazy</strong>: no elements are produced until a terminal operation runs</li>
<li><strong>Pull-based</strong>: the consumer drives evaluation, providing natural backpressure</li>
<li><strong>Virtual thread execution</strong>: each pull returns a VTask, leveraging virtual threads</li>
<li><strong>Step protocol</strong>: Emit (value + continuation), Done (exhausted), Skip (efficient filtering)</li>
<li><strong>Stack-safe</strong>: all terminal operations use iterative loops; flatMap handles deep chains</li>
<li><strong>Composable</strong>: map, flatMap, filter, take chain lazily into pipelines</li>
<li><strong>Error recovery</strong>: recover and recoverWith handle failures at the stream level</li>
</ul>
</div>
</div>
<div id="admonition-hands-on-learning" class="admonition admonish-info" role="note" aria-labelledby="admonition-hands-on-learning-title">
<div class="admonition-title">
<div id="admonition-hands-on-learning-title">
<p>Hands-On Learning</p>
</div>
<a class="admonition-anchor-link" href="#admonition-hands-on-learning"></a>
</div>
<div>
<p>Practice VStream basics in <a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/test/java/org/higherkindedj/tutorial/concurrency/TutorialVStream.java">TutorialVStream</a> (11 exercises, ~12-15 minutes).</p>
</div>
</div>
<div id="admonition-benchmarks" class="admonition admonish-example" role="note" aria-labelledby="admonition-benchmarks-title">
<div class="admonition-title">
<div id="admonition-benchmarks-title">
<p>Benchmarks</p>
</div>
<a class="admonition-anchor-link" href="#admonition-benchmarks"></a>
</div>
<div>
<p>VStream has a dedicated JMH benchmark suite measuring construction, combinator pipelines, terminal operations, and comparison with raw Java Streams. Run it with:</p>
<pre><code class="language-bash">./gradlew :hkj-benchmarks:jmh --includes=".*VStreamBenchmark.*"
</code></pre>
<p>See <a href="../benchmarks.html">Benchmarks &amp; Performance</a> for full details and how to interpret results.</p>
</div>
</div>
<div id="admonition-see-also" class="admonition admonish-tip" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See Also</p>
</div>
<a class="admonition-anchor-link" href="#admonition-see-also"></a>
</div>
<div>
<ul>
<li><a href="vtask_monad.html">VTask</a> - The single-value effect type that powers VStream pulls</li>
<li><a href="../effect/path_vtask.html">VTaskPath</a> - Fluent Path API wrapper for VTask</li>
<li><a href="stream_monad.html">Stream</a> - Eager list-based streaming</li>
</ul>
</div>
</div>
<hr />
<p><strong>Previous:</strong> <a href="vtask_resource.html">Resource Management</a>
<strong>Next:</strong> <a href="writer_monad.html">Writer</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../monads/vtask_resource.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../monads/writer_monad.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../monads/vtask_resource.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../monads/writer_monad.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../version-switcher.js"></script>
        <script src=".././theme/version-switcher.js"></script>
        <script src=".././theme/sidebar-nav-link.js"></script>


    </div>
    </body>
</html>
