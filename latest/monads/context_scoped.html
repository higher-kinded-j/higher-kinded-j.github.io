<!DOCTYPE HTML>
<html lang="en" class="latte sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Context - Higher-Kinded-J: Composable Effects and Advanced Optics for Java</title>


        <!-- Custom HTML head -->


            <meta name="description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">


        <meta name="keywords" content="Higher-Kinded Types, Higher-Kinded-J, HKT, Java, Optics, Lens, Prism, Traversal, Iso, Affine, Focus DSL, Effect Path API, Functional Programming, Monad, Functor, Applicative, EitherPath, MaybePath, TryPath, ValidationPath, Java Records, Sealed Interface, Error Handling, Immutable Data">
        
        <meta property="og:title" content="Context - Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
            <meta property="og:description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://higher-kinded-j.github.io/">
        <meta property="og:image" content="https://higher-kinded-j.github.io/preview.png">
        <meta property="og:image:width" content="1200">
        <meta property="og:image:height" content="630">
        <meta property="og:site_name" content="Higher-Kinded-J Documentation">
        <meta property="og:locale" content="en_GB">
        
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="Context - Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
        <meta name="twitter:description" content="Unifying Composable Effects and Advanced Optics for Java. Effect Path API, Focus DSL, and the most comprehensive optics implementation in the Java ecosystem.">
        <meta name="twitter:image" content="https://higher-kinded-j.github.io/preview.png">
        <meta name="twitter:image:alt" content="Higher-Kinded-J: Composable Effects and Advanced Optics for Java">
        <meta name="description" content="The most comprehensive functional programming library for Java. Unify error handling, optional values, and immutable data navigation with the Effect Path API and Focus DSL. Features advanced optics with code generation for Java records, filtered traversals, indexed optics, and seamless Spring Boot integration.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">
        <meta name="google-site-verification" content="X-xsiAq2cKMLOzh9dexUrX8Onx2h_YMUFgp5lHHUwSg" />
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin.css">
        <link rel="stylesheet" href=".././theme/catppuccin-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin-alerts.css">
        <link rel="stylesheet" href=".././theme/additional-hkj.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "latte";
            const default_dark_theme = "macchiato";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('latte')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frappé</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        <div class="version-selector-container">
                            <select id="version-selector" class="version-selector" aria-label="Select documentation version" title="Select documentation version">
                                <option value="">Loading versions...</option>
                            </select>
                        </div>
                    </div>

                    <h1 class="menu-title">Higher-Kinded-J: Composable Effects and Advanced Optics for Java</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j/edit/main/hkj-book/src/monads/context_scoped.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="the-context-effect-virtual-thread-scoped-context-propagation"><a class="header" href="#the-context-effect-virtual-thread-scoped-context-propagation">The Context Effect: Virtual Thread-Scoped Context Propagation</a></h1>
<blockquote>
<p><em>"This was no boat accident."</em></p>
<p>-- Hooper, <em>Jaws</em></p>
</blockquote>
<p>When code behaves unexpectedly in concurrent systems, it's rarely random. There's something beneath the surface: context that was set elsewhere, state that travelled invisibly, assumptions that held on one thread but failed on another. The experienced developer learns to suspect these hidden currents.</p>
<blockquote>
<p><em>"A paranoid is someone who knows a little of what's going on."</em></p>
<p>-- William S. Burroughs</p>
</blockquote>
<p>Java's <code>ScopedValue</code> API makes those currents visible. Where <code>ThreadLocal</code> let context drift silently through your application (sometimes appearing where it shouldn't, sometimes vanishing where it should) <code>ScopedValue</code> enforces explicit boundaries. You declare what flows into a scope. You control what child threads inherit. The paranoid developer becomes the informed one.</p>
<p><code>Context&lt;R, A&gt;</code> brings this power into Higher-Kinded-J's functional vocabulary, providing a composable effect type for reading scoped values with full integration into the VTask and Scope ecosystem.</p>
<div id="admonition-what-youll-learn" class="admonition admonish-info" role="note" aria-labelledby="admonition-what-youll-learn-title">
<div class="admonition-title">
<div id="admonition-what-youll-learn-title">
<p>What You'll Learn</p>
</div>
<a class="admonition-anchor-link" href="#admonition-what-youll-learn"></a>
</div>
<div>
<ul>
<li>Why <code>ThreadLocal</code> breaks down with virtual threads</li>
<li>How <code>ScopedValue</code> provides thread-safe context propagation</li>
<li>Using <code>Context&lt;R, A&gt;</code> to read and compose scoped computations</li>
<li>Integrating Context with VTask for concurrent context propagation</li>
<li>Building request tracing and security patterns</li>
<li>MDC-style logging with ScopedValues</li>
</ul>
</div>
</div>
<div id="admonition-java-25-feature" class="admonition admonish-warning" role="note" aria-labelledby="admonition-java-25-feature-title">
<div class="admonition-title">
<div id="admonition-java-25-feature-title">
<p>Java 25+ Feature</p>
</div>
<a class="admonition-anchor-link" href="#admonition-java-25-feature"></a>
</div>
<div>
<p><code>Context&lt;R, A&gt;</code> uses Java's <code>ScopedValue</code> API (JEP 506), finalised in Java 25. This API provides:</p>
<ul>
<li><strong>Immutability</strong>: Values cannot be changed once bound to a scope</li>
<li><strong>Inheritance</strong>: Child virtual threads automatically inherit parent bindings</li>
<li><strong>Bounded lifetime</strong>: Values exist only within their declared scope</li>
<li><strong>Performance</strong>: Optimised for virtual thread access patterns</li>
</ul>
<p>Ensure your project targets Java 25 or later to use these features.</p>
</div>
</div>
<div id="admonition-example-code" class="admonition admonish-example" role="note" aria-labelledby="admonition-example-code-title">
<div class="admonition-title">
<div id="admonition-example-code-title">
<p>Example Code</p>
</div>
<a class="admonition-anchor-link" href="#admonition-example-code"></a>
</div>
<div>
<ul>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/context/ContextBasicExample.java">ContextBasicExample.java</a> -- Core Context usage patterns</li>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/context/ContextScopeExample.java">ContextScopeExample.java</a> -- Integration with structured concurrency</li>
</ul>
</div>
</div>
<hr />
<h2 id="the-problem-threadlocal-in-the-virtual-thread-era"><a class="header" href="#the-problem-threadlocal-in-the-virtual-thread-era">The Problem: ThreadLocal in the Virtual Thread Era</a></h2>
<p><code>ThreadLocal</code> served Java well for two decades. It provided thread-confined storage for request context, security principals, and transaction state. But virtual threads expose its fundamental weakness.</p>
<p>Consider a typical web application:</p>
<pre><code class="language-java">// Traditional ThreadLocal pattern
public class RequestContext {
    private static final ThreadLocal&lt;String&gt; TRACE_ID = new ThreadLocal&lt;&gt;();

    public static void setTraceId(String id) { TRACE_ID.set(id); }
    public static String getTraceId() { return TRACE_ID.get(); }
}

// In a request handler
public Response handleRequest(Request request) {
    RequestContext.setTraceId(request.traceId());
    try {
        return processRequest(request);  // Deep call stack reads TRACE_ID
    } finally {
        RequestContext.setTraceId(null);  // Must clean up!
    }
}
</code></pre>
<p>This pattern has three problems with virtual threads:</p>
<p><strong>1. Unbounded Accumulation</strong></p>
<p>Virtual threads are cheap; you might have millions. Each <code>ThreadLocal</code> allocates storage per thread. With platform threads, this was manageable (hundreds of threads). With virtual threads, memory usage explodes.</p>
<p><strong>2. Inheritance Confusion</strong></p>
<p>When you fork a virtual thread, does it inherit the parent's <code>ThreadLocal</code> values? With <code>InheritableThreadLocal</code>, yes, but the child gets a <em>copy</em>. Changes in the parent don't propagate. Changes in the child don't propagate back. This silent divergence causes subtle bugs.</p>
<p><strong>3. Cleanup Burden</strong></p>
<p>Forgetting to clear a <code>ThreadLocal</code> causes memory leaks and context pollution. Virtual threads make this worse: their lightweight nature encourages creating many short-lived threads, each requiring cleanup.</p>
<hr />
<h2 id="the-solution-scopedvalue-backed-context"><a class="header" href="#the-solution-scopedvalue-backed-context">The Solution: ScopedValue-Backed Context</a></h2>
<p>Java 25's <code>ScopedValue</code> addresses these problems through different semantics:</p>
<pre><code class="language-java">// ScopedValue pattern
public class RequestContext {
    public static final ScopedValue&lt;String&gt; TRACE_ID = ScopedValue.newInstance();
}

// In a request handler
public Response handleRequest(Request request) {
    return ScopedValue
        .where(RequestContext.TRACE_ID, request.traceId())
        .call(() -&gt; processRequest(request));  // TRACE_ID visible in entire scope
    // No cleanup needed -- scope ends, binding disappears
}
</code></pre>
<p><strong>Key differences:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Aspect</th><th>ThreadLocal</th><th>ScopedValue</th></tr></thead><tbody>
<tr><td>Mutability</td><td>Mutable (<code>set()</code> anytime)</td><td>Immutable within scope</td></tr>
<tr><td>Inheritance</td><td>Copies value (diverges)</td><td>Shares binding (consistent)</td></tr>
<tr><td>Cleanup</td><td>Manual (error-prone)</td><td>Automatic (scope-based)</td></tr>
<tr><td>Memory</td><td>Per-thread allocation</td><td>Optimised for virtual threads</td></tr>
</tbody></table>
</div>
<p><code>Context&lt;R, A&gt;</code> wraps <code>ScopedValue</code> access in a functional effect type, enabling composition with <code>map</code>, <code>flatMap</code>, and integration with VTask.</p>
<hr />
<h2 id="purpose"><a class="header" href="#purpose">Purpose</a></h2>
<p><code>Context&lt;R, A&gt;</code> represents a computation that reads a value of type <code>R</code> from a <code>ScopedValue&lt;R&gt;</code> and produces a result of type <code>A</code>. It's conceptually similar to <code>Reader&lt;R, A&gt;</code>, but with crucial differences:</p>
<ul>
<li><strong>Reader</strong>: Requires explicit parameter passing at <code>run(r)</code></li>
<li><strong>Context</strong>: Reads from thread-scoped <code>ScopedValue</code>, inherits automatically across virtual thread boundaries</li>
</ul>
<pre><code>┌─────────────────────────────────────────────────────────────────────┐
│                         Context&lt;R, A&gt;                               │
│                                                                     │
│   A computation that:                                               │
│   1. Reads from a ScopedValue&lt;R&gt;                                    │
│   2. Produces a value of type A                                     │
│   3. Can be composed with map/flatMap                               │
│   4. Integrates with VTask for concurrent execution                 │
│                                                                     │
│   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐        │
│   │    define    │ ──► │   compose    │ ──► │   provide    │        │
│   │   Context    │     │   with map/  │     │  ScopedValue │        │
│   │  .ask(KEY)   │     │   flatMap    │     │   binding    │        │
│   └──────────────┘     └──────────────┘     └──────────────┘        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
</code></pre>
<hr />
<h2 id="core-architecture"><a class="header" href="#core-architecture">Core Architecture</a></h2>
<pre><code>┌─────────────────────────────────────────────────────────────────────┐
│                      hkj-api module                                 │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  ContextKind&lt;R, A&gt;                                            │  │
│  │  ─────────────────                                            │  │
│  │  HKT witness interface for Context                            │  │
│  │  Enables integration with type class hierarchy                │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                      hkj-core module                                │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Context&lt;R, A&gt;  (sealed interface)                            │  │
│  │  ─────────────────────────────────                            │  │
│  │  • ask(ScopedValue&lt;R&gt;) -- read the scoped value               │  │
│  │  • asks(ScopedValue&lt;R&gt;, Function&lt;R,A&gt;) -- read and transform  │  │
│  │  • succeed(A) -- lift a pure value                            │  │
│  │  • fail(Throwable) -- represent failure                       │  │
│  │  • map(Function&lt;A,B&gt;) -- transform the result                 │  │
│  │  • flatMap(Function&lt;A, Context&lt;R,B&gt;&gt;) -- chain contexts       │  │
│  │  • toVTask(ScopedValue&lt;R&gt;) -- convert to VTask                │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ▼                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  ContextMonad&lt;R&gt;                                              │  │
│  │  ─────────────────                                            │  │
│  │  Monad instance for Context&lt;R, _&gt;                             │  │
│  │  Provides pure, map, flatMap, ap for HKT composition          │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  ContextOps                                                   │  │
│  │  ───────────                                                  │  │
│  │  Static utilities for common patterns:                        │  │
│  │  • withContext(VTask&lt;A&gt;, ScopedValue&lt;R&gt;, R) -- run with value │  │
│  │  • propagate(ScopedValue&lt;R&gt;...) -- propagate to forked tasks  │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌─────────────────────────┐  ┌─────────────────────────────────┐   │
│  │  RequestContext         │  │  SecurityContext                │   │
│  │  ──────────────         │  │  ───────────────                │   │
│  │  TRACE_ID               │  │  PRINCIPAL                      │   │
│  │  CORRELATION_ID         │  │  ROLES                          │   │
│  │  LOCALE                 │  │  AUTH_TOKEN                     │   │
│  │  REQUEST_TIME           │  │  hasRole(), requireRole()       │   │
│  └─────────────────────────┘  └─────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
</code></pre>
<hr />
<h2 id="how-to-use-contextr-a"><a class="header" href="#how-to-use-contextr-a">How to Use Context&lt;R, A&gt;</a></h2>
<h3 id="creating-a-scopedvalue"><a class="header" href="#creating-a-scopedvalue">Creating a ScopedValue</a></h3>
<p>First, define your scoped values as static finals:</p>
<pre><code class="language-java">public final class AppContext {
    private AppContext() {}  // Utility class

    /** Current user's preferred locale. */
    public static final ScopedValue&lt;Locale&gt; LOCALE = ScopedValue.newInstance();

    /** Trace ID for distributed tracing. */
    public static final ScopedValue&lt;String&gt; TRACE_ID = ScopedValue.newInstance();

    /** Current tenant in multi-tenant application. */
    public static final ScopedValue&lt;String&gt; TENANT_ID = ScopedValue.newInstance();
}
</code></pre>
<div id="admonition-scopedvalue-naming-convention" class="admonition admonish-tip" role="note" aria-labelledby="admonition-scopedvalue-naming-convention-title">
<div class="admonition-title">
<div id="admonition-scopedvalue-naming-convention-title">
<p>ScopedValue Naming Convention</p>
</div>
<a class="admonition-anchor-link" href="#admonition-scopedvalue-naming-convention"></a>
</div>
<div>
<p>Define <code>ScopedValue</code> instances as <code>public static final</code> fields in a dedicated utility class. Use SCREAMING_SNAKE_CASE for the field name, matching the convention for constants. This makes the scoped values easy to discover and reference.</p>
</div>
</div>
<h3 id="reading-with-contextask"><a class="header" href="#reading-with-contextask">Reading with Context.ask</a></h3>
<p>The simplest way to read a scoped value:</p>
<pre><code class="language-java">// Read the LOCALE value
Context&lt;Locale, Locale&gt; getLocale = Context.ask(AppContext.LOCALE);

// Read TRACE_ID
Context&lt;String, String&gt; getTraceId = Context.ask(AppContext.TRACE_ID);
</code></pre>
<p><code>Context.ask(key)</code> returns a <code>Context&lt;R, R&gt;</code>; it reads the value and returns it unchanged.</p>
<h3 id="reading-and-transforming-with-contextasks"><a class="header" href="#reading-and-transforming-with-contextasks">Reading and Transforming with Context.asks</a></h3>
<p>Often you want to read and immediately transform:</p>
<pre><code class="language-java">// Read locale and get the language tag
Context&lt;Locale, String&gt; getLanguage =
    Context.asks(AppContext.LOCALE, Locale::toLanguageTag);

// Read trace ID and format for logging
Context&lt;String, String&gt; getLogPrefix =
    Context.asks(AppContext.TRACE_ID, id -&gt; "[" + id + "] ");

// Read tenant and build connection string
Context&lt;String, String&gt; getConnectionString =
    Context.asks(AppContext.TENANT_ID, tenant -&gt;
        "jdbc:postgresql://db/" + tenant + "_database");
</code></pre>
<h3 id="transforming-results-with-map"><a class="header" href="#transforming-results-with-map">Transforming Results with map</a></h3>
<p>Transform the output of a context computation:</p>
<pre><code class="language-java">Context&lt;Locale, String&gt; getLocale = Context.ask(AppContext.LOCALE);

// Transform to language tag
Context&lt;Locale, String&gt; getLanguageTag = getLocale.map(Locale::toLanguageTag);

// Transform to display name
Context&lt;Locale, String&gt; getDisplayName = getLocale.map(Locale::getDisplayName);

// Chain multiple transformations
Context&lt;Locale, String&gt; getUpperCaseLanguage = getLocale
    .map(Locale::toLanguageTag)
    .map(String::toUpperCase);
</code></pre>
<h3 id="chaining-with-flatmap"><a class="header" href="#chaining-with-flatmap">Chaining with flatMap</a></h3>
<p>Compose contexts that depend on previous results:</p>
<pre><code class="language-java">// First context: get the tenant ID
Context&lt;String, String&gt; getTenant = Context.ask(AppContext.TENANT_ID);

// Second context: use tenant to look up configuration
// (Assume TENANT_CONFIGS is a Map&lt;String, TenantConfig&gt;)
Context&lt;String, TenantConfig&gt; getTenantConfig = getTenant.flatMap(tenantId -&gt;
    Context.succeed(TENANT_CONFIGS.get(tenantId)));

// Chain multiple dependent operations
Context&lt;String, DatabaseConnection&gt; getConnection = getTenant
    .flatMap(tenantId -&gt; Context.succeed(buildConnectionString(tenantId)))
    .flatMap(connStr -&gt; Context.succeed(openConnection(connStr)));
</code></pre>
<h3 id="combining-multiple-scoped-values"><a class="header" href="#combining-multiple-scoped-values">Combining Multiple Scoped Values</a></h3>
<p>Since <code>Context&lt;R, A&gt;</code> is parameterised by the scoped value type <code>R</code>, you cannot directly chain contexts with different <code>R</code> types using <code>flatMap</code>. Instead, convert to <code>VTask</code> first:</p>
<pre><code class="language-java">// Convert each Context to VTask, then combine
VTask&lt;RequestInfo&gt; gatherRequestInfo =
    Context.ask(AppContext.TRACE_ID).toVTask().flatMap(traceId -&gt;
        Context.ask(AppContext.LOCALE).toVTask().flatMap(locale -&gt;
            Context.ask(AppContext.TENANT_ID).toVTask().map(tenant -&gt;
                new RequestInfo(traceId, locale, tenant))));

// Or use Context.map2/map3 for same-type contexts
// These work when all contexts read from the SAME ScopedValue type
Context&lt;String, String&gt; combined = Context.map2(
    Context.asks(AppContext.TRACE_ID, id -&gt; id),
    Context.asks(AppContext.TRACE_ID, id -&gt; id.toUpperCase()),
    (lower, upper) -&gt; lower + " -&gt; " + upper);
</code></pre>
<div id="admonition-why-tovtask" class="admonition admonish-tip" role="note" aria-labelledby="admonition-why-tovtask-title">
<div class="admonition-title">
<div id="admonition-why-tovtask-title">
<p>Why toVTask()?</p>
</div>
<a class="admonition-anchor-link" href="#admonition-why-tovtask"></a>
</div>
<div>
<p><code>Context&lt;R, A&gt;.flatMap</code> requires the continuation to return <code>Context&lt;R, B&gt;</code> with the <strong>same</strong> <code>R</code> type. When reading from different <code>ScopedValue</code> types (e.g., <code>ScopedValue&lt;String&gt;</code> and <code>ScopedValue&lt;Locale&gt;</code>), convert to <code>VTask</code> first. <code>VTask</code> isn't parameterised by context type, so it can freely combine values from different sources.</p>
</div>
</div>
<hr />
<h2 id="providing-context-values"><a class="header" href="#providing-context-values">Providing Context Values</a></h2>
<h3 id="basic-binding-with-scopedvaluewhere"><a class="header" href="#basic-binding-with-scopedvaluewhere">Basic Binding with ScopedValue.where</a></h3>
<p>Bind a value and execute within the scope:</p>
<pre><code class="language-java">ScopedValue&lt;String&gt; TRACE_ID = ScopedValue.newInstance();

Context&lt;String, String&gt; logMessage =
    Context.asks(TRACE_ID, id -&gt; "[" + id + "] Processing request");

// Provide the value and run
String result = ScopedValue
    .where(TRACE_ID, "trace-abc-123")
    .call(() -&gt; logMessage.run());

System.out.println(result);  // [trace-abc-123] Processing request
</code></pre>
<h3 id="multiple-bindings"><a class="header" href="#multiple-bindings">Multiple Bindings</a></h3>
<p>Chain multiple bindings for several scoped values:</p>
<pre><code class="language-java">String result = ScopedValue
    .where(AppContext.TRACE_ID, "trace-123")
    .where(AppContext.LOCALE, Locale.UK)
    .where(AppContext.TENANT_ID, "acme-corp")
    .call(() -&gt; {
        // All three values available in this scope
        return processRequest().run();
    });
</code></pre>
<h3 id="converting-to-vtask"><a class="header" href="#converting-to-vtask">Converting to VTask</a></h3>
<p>For integration with the VTask ecosystem:</p>
<pre><code class="language-java">Context&lt;String, ProcessedData&gt; processWithTrace =
    Context.ask(AppContext.TRACE_ID)
           .map(traceId -&gt; processor.process(traceId));

// Convert to VTask that reads from current scope
VTask&lt;ProcessedData&gt; task = processWithTrace.toVTask();

// Execute within a scope
Try&lt;ProcessedData&gt; result = ScopedValue
    .where(AppContext.TRACE_ID, "trace-xyz")
    .call(() -&gt; task.runSafe());
</code></pre>
<hr />
<h2 id="integration-with-vtask-and-scope"><a class="header" href="#integration-with-vtask-and-scope">Integration with VTask and Scope</a></h2>
<h3 id="context-in-vtask-pipelines"><a class="header" href="#context-in-vtask-pipelines">Context in VTask Pipelines</a></h3>
<p>Combine Context with VTask for effectful computations:</p>
<pre><code class="language-java">public VTask&lt;Response&gt; handleRequest(Request request) {
    // Build the computation
    VTask&lt;Response&gt; pipeline = VTask
        .delay(() -&gt; validateRequest(request))
        .flatMap(valid -&gt; processRequest(valid))
        .flatMap(result -&gt; formatResponse(result));

    // Execute with context
    return ScopedValue
        .where(RequestContext.TRACE_ID, request.traceId())
        .where(RequestContext.LOCALE, request.locale())
        .call(() -&gt; pipeline);
}

// Deep in the call stack, context is available
private VTask&lt;ProcessedData&gt; processRequest(ValidatedRequest request) {
    return VTask.delay(() -&gt; {
        String traceId = RequestContext.TRACE_ID.get();  // Available!
        logger.info("[{}] Processing: {}", traceId, request);
        return doProcess(request);
    });
}
</code></pre>
<h3 id="context-propagation-in-scope"><a class="header" href="#context-propagation-in-scope">Context Propagation in Scope</a></h3>
<p>Virtual threads forked within a scope inherit scoped values:</p>
<pre><code class="language-java">public VTask&lt;AggregatedResult&gt; fetchAllData(String userId) {
    return ScopedValue
        .where(RequestContext.TRACE_ID, generateTraceId())
        .call(() -&gt;
            Scope.&lt;PartialResult&gt;allSucceed()
                .fork(fetchUserProfile(userId))   // Inherits TRACE_ID
                .fork(fetchUserOrders(userId))    // Inherits TRACE_ID
                .fork(fetchUserPreferences(userId)) // Inherits TRACE_ID
                .join((profile, orders, prefs) -&gt;
                    new AggregatedResult(profile, orders, prefs))
        );
}

// Each forked task sees the same TRACE_ID
private VTask&lt;UserProfile&gt; fetchUserProfile(String userId) {
    return VTask.delay(() -&gt; {
        String traceId = RequestContext.TRACE_ID.get();  // Same as parent!
        logger.info("[{}] Fetching profile for {}", traceId, userId);
        return profileService.fetch(userId);
    });
}
</code></pre>
<pre><code>          Main Thread
               │
               │ ScopedValue.where(TRACE_ID, "abc-123")
               │
               ▼
        ┌──────────────┐
        │   Scope      │
        │  .allSucceed │
        └──────┬───────┘
               │
       ┌───────┼───────┐
       │       │       │
       ▼       ▼       ▼
   ┌──────┐ ┌──────┐ ┌──────┐
   │ fork │ │ fork │ │ fork │
   │  #1  │ │  #2  │ │  #3  │
   └──────┘ └──────┘ └──────┘
       │       │       │
       │ TRACE_ID = "abc-123" (inherited)
       │       │       │
       ▼       ▼       ▼
   [profile] [orders] [prefs]
</code></pre>
<h3 id="overriding-context-in-forked-tasks"><a class="header" href="#overriding-context-in-forked-tasks">Overriding Context in Forked Tasks</a></h3>
<p>You can override context for specific forked tasks:</p>
<pre><code class="language-java">Scope.&lt;Result&gt;allSucceed()
    .fork(normalTask())  // Uses parent TRACE_ID
    .fork(() -&gt; ScopedValue
        .where(RequestContext.TRACE_ID, "override-456")
        .call(() -&gt; specialTask().run()))  // Uses overridden TRACE_ID
    .join((normal, special) -&gt; combine(normal, special));
</code></pre>
<hr />
<h2 id="context-vs-reader"><a class="header" href="#context-vs-reader">Context vs Reader</a></h2>
<p>Both <code>Context&lt;R, A&gt;</code> and <code>Reader&lt;R, A&gt;</code> represent computations that read from an environment. When should you use each?</p>
<h3 id="reader-explicit-parameter-passing"><a class="header" href="#reader-explicit-parameter-passing">Reader: Explicit Parameter Passing</a></h3>
<pre><code class="language-java">Reader&lt;Config, String&gt; getHost = Reader.asks(Config::hostname);

// Must explicitly provide Config at run time
String host = getHost.run(productionConfig);
</code></pre>
<p><strong>Use Reader when:</strong></p>
<ul>
<li>Configuration is passed at application startup</li>
<li>You want explicit, visible dependency injection</li>
<li>Thread propagation is not a concern</li>
<li>You're in single-threaded or carefully managed contexts</li>
</ul>
<h3 id="context-implicit-thread-scoped-propagation"><a class="header" href="#context-implicit-thread-scoped-propagation">Context: Implicit Thread-Scoped Propagation</a></h3>
<pre><code class="language-java">Context&lt;Config, String&gt; getHost = Context.asks(CONFIG, Config::hostname);

// Value comes from ScopedValue binding
String host = ScopedValue
    .where(CONFIG, productionConfig)
    .call(() -&gt; getHost.run());
</code></pre>
<p><strong>Use Context when:</strong></p>
<ul>
<li>Values must propagate through virtual thread forks</li>
<li>Deep call stacks need access without parameter drilling</li>
<li>Per-request data (trace IDs, user identity) needs implicit flow</li>
<li>You're building concurrent applications with structured concurrency</li>
</ul>
<h3 id="comparison-table"><a class="header" href="#comparison-table">Comparison Table</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Aspect</th><th>Reader</th><th>Context</th></tr></thead><tbody>
<tr><td>Environment source</td><td>Explicit <code>run(r)</code> parameter</td><td><code>ScopedValue</code> binding</td></tr>
<tr><td>Thread inheritance</td><td>None (must pass explicitly)</td><td>Automatic in virtual threads</td></tr>
<tr><td>Typical use</td><td>App configuration</td><td>Request-scoped data</td></tr>
<tr><td>Visibility</td><td>Explicit in signatures</td><td>Implicit (can be hidden)</td></tr>
<tr><td>Testing</td><td>Pass mock config to <code>run()</code></td><td>Bind mock in <code>ScopedValue.where()</code></td></tr>
<tr><td>Java version</td><td>Any</td><td>Java 25+</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="mdc-style-logging-integration"><a class="header" href="#mdc-style-logging-integration">MDC-Style Logging Integration</a></h2>
<p>A common use case for scoped context is structured logging. Traditional MDC (Mapped Diagnostic Context) uses <code>ThreadLocal</code> internally, which has the problems described earlier. Here's how to build MDC-style logging with <code>ScopedValue</code>:</p>
<h3 id="defining-logging-context"><a class="header" href="#defining-logging-context">Defining Logging Context</a></h3>
<pre><code class="language-java">public final class LogContext {
    private LogContext() {}

    public static final ScopedValue&lt;String&gt; TRACE_ID = ScopedValue.newInstance();
    public static final ScopedValue&lt;String&gt; SPAN_ID = ScopedValue.newInstance();
    public static final ScopedValue&lt;String&gt; USER_ID = ScopedValue.newInstance();

    /**
     * Formats the current context as a log prefix.
     * Returns empty string if no context is bound.
     */
    public static String prefix() {
        StringBuilder sb = new StringBuilder();
        if (TRACE_ID.isBound()) {
            sb.append("[trace=").append(TRACE_ID.get()).append("] ");
        }
        if (SPAN_ID.isBound()) {
            sb.append("[span=").append(SPAN_ID.get()).append("] ");
        }
        if (USER_ID.isBound()) {
            sb.append("[user=").append(USER_ID.get()).append("] ");
        }
        return sb.toString();
    }
}
</code></pre>
<h3 id="context-aware-logging"><a class="header" href="#context-aware-logging">Context-Aware Logging</a></h3>
<pre><code class="language-java">public final class ContextLogger {
    private final Logger delegate;

    public ContextLogger(Class&lt;?&gt; clazz) {
        this.delegate = LoggerFactory.getLogger(clazz);
    }

    public void info(String message, Object... args) {
        delegate.info(LogContext.prefix() + message, args);
    }

    public void error(String message, Throwable t) {
        delegate.error(LogContext.prefix() + message, t);
    }

    // ... other log levels
}

// Usage
public class OrderService {
    private static final ContextLogger log = new ContextLogger(OrderService.class);

    public Order processOrder(OrderRequest request) {
        log.info("Processing order: {}", request.id());
        // ... processing
        log.info("Order completed successfully");
        return order;
    }
}
</code></pre>
<h3 id="automatic-context-propagation-in-logs"><a class="header" href="#automatic-context-propagation-in-logs">Automatic Context Propagation in Logs</a></h3>
<p>When using <code>Scope</code>, all forked tasks inherit the logging context:</p>
<pre><code class="language-java">public VTask&lt;OrderResult&gt; processOrderConcurrently(OrderRequest request) {
    return ScopedValue
        .where(LogContext.TRACE_ID, request.traceId())
        .where(LogContext.USER_ID, request.userId())
        .call(() -&gt;
            Scope.&lt;PartialResult&gt;allSucceed()
                .fork(validateInventory(request))   // Logs with same trace/user
                .fork(calculateShipping(request))   // Logs with same trace/user
                .fork(processPayment(request))      // Logs with same trace/user
                .join(OrderResult::new)
        );
}
</code></pre>
<p>Sample log output:</p>
<pre><code>[trace=ord-789] [user=alice] Processing order: ORD-001
[trace=ord-789] [user=alice] Validating inventory for 3 items
[trace=ord-789] [user=alice] Calculating shipping to postcode SW1A 1AA
[trace=ord-789] [user=alice] Processing payment of £49.99
[trace=ord-789] [user=alice] Order completed successfully
</code></pre>
<h3 id="integration-with-existing-logging-frameworks"><a class="header" href="#integration-with-existing-logging-frameworks">Integration with Existing Logging Frameworks</a></h3>
<p>For integration with SLF4J MDC (which uses <code>ThreadLocal</code>), you can bridge at scope boundaries:</p>
<pre><code class="language-java">public &lt;T&gt; T withMdcBridge(Callable&lt;T&gt; task) throws Exception {
    // Copy ScopedValues to MDC at scope entry
    if (LogContext.TRACE_ID.isBound()) {
        MDC.put("traceId", LogContext.TRACE_ID.get());
    }
    if (LogContext.USER_ID.isBound()) {
        MDC.put("userId", LogContext.USER_ID.get());
    }
    try {
        return task.call();
    } finally {
        MDC.clear();
    }
}
</code></pre>
<div id="admonition-mdc-bridge-limitations" class="admonition admonish-warning" role="note" aria-labelledby="admonition-mdc-bridge-limitations-title">
<div class="admonition-title">
<div id="admonition-mdc-bridge-limitations-title">
<p>MDC Bridge Limitations</p>
</div>
<a class="admonition-anchor-link" href="#admonition-mdc-bridge-limitations"></a>
</div>
<div>
<p>The MDC bridge only works within a single thread. Forked virtual threads won't automatically get MDC values; they'll get <code>ScopedValue</code> bindings. For consistent logging in concurrent code, use the <code>ContextLogger</code> pattern shown above rather than relying on MDC.</p>
</div>
</div>
<hr />
<h2 id="handling-unbound-scopedvalues"><a class="header" href="#handling-unbound-scopedvalues">Handling Unbound ScopedValues</a></h2>
<p>What happens when code tries to read a <code>ScopedValue</code> that hasn't been bound?</p>
<h3 id="default-behaviour-exception"><a class="header" href="#default-behaviour-exception">Default Behaviour: Exception</a></h3>
<pre><code class="language-java">Context&lt;String, String&gt; getTraceId = Context.ask(TRACE_ID);

// If TRACE_ID is not bound, this throws NoSuchElementException
String traceId = getTraceId.run();
</code></pre>
<p>This fail-fast behaviour is intentional; it surfaces configuration errors immediately rather than allowing silent failures.</p>
<h3 id="checking-binding-status"><a class="header" href="#checking-binding-status">Checking Binding Status</a></h3>
<pre><code class="language-java">// Check if bound before reading
if (TRACE_ID.isBound()) {
    String traceId = TRACE_ID.get();
    // ... use traceId
} else {
    // Handle missing context
}

// Or with Context
Context&lt;String, Maybe&lt;String&gt;&gt; safeGetTraceId =
    Context.succeed(TRACE_ID.isBound()
        ? Maybe.just(TRACE_ID.get())
        : Maybe.nothing());
</code></pre>
<h3 id="providing-defaults"><a class="header" href="#providing-defaults">Providing Defaults</a></h3>
<pre><code class="language-java">// Get value or use default
Context&lt;String, String&gt; getTraceIdOrDefault =
    Context.succeed(TRACE_ID.isBound()
        ? TRACE_ID.get()
        : "no-trace");

// Helper method pattern
public static &lt;T&gt; T getOrDefault(ScopedValue&lt;T&gt; key, T defaultValue) {
    return key.isBound() ? key.get() : defaultValue;
}
</code></pre>
<hr />
<h2 id="pre-built-context-patterns"><a class="header" href="#pre-built-context-patterns">Pre-Built Context Patterns</a></h2>
<p>Higher-Kinded-J provides two pre-built context utilities for common patterns:</p>
<h3 id="requestcontext"><a class="header" href="#requestcontext">RequestContext</a></h3>
<p>For HTTP request tracing and metadata propagation:</p>
<pre><code class="language-java">public final class RequestContext {
    public static final ScopedValue&lt;String&gt; TRACE_ID = ScopedValue.newInstance();
    public static final ScopedValue&lt;String&gt; CORRELATION_ID = ScopedValue.newInstance();
    public static final ScopedValue&lt;Locale&gt; LOCALE = ScopedValue.newInstance();
    public static final ScopedValue&lt;Instant&gt; REQUEST_TIME = ScopedValue.newInstance();
    // ... helper methods
}
</code></pre>
<p>See <a href="../effect/context_request.html">RequestContext Patterns</a> for detailed documentation.</p>
<h3 id="securitycontext"><a class="header" href="#securitycontext">SecurityContext</a></h3>
<p>For authentication and authorisation patterns:</p>
<pre><code class="language-java">public final class SecurityContext {
    public static final ScopedValue&lt;Principal&gt; PRINCIPAL = ScopedValue.newInstance();
    public static final ScopedValue&lt;Set&lt;String&gt;&gt; ROLES = ScopedValue.newInstance();
    public static final ScopedValue&lt;String&gt; AUTH_TOKEN = ScopedValue.newInstance();

    public static Context&lt;Set&lt;String&gt;, Boolean&gt; hasRole(String role) { ... }
    public static Context&lt;Set&lt;String&gt;, Unit&gt; requireRole(String role) { ... }
    // ... more helpers
}
</code></pre>
<p>See <a href="../effect/context_security.html">SecurityContext Patterns</a> for detailed documentation.</p>
<hr />
<h2 id="testing-with-context"><a class="header" href="#testing-with-context">Testing with Context</a></h2>
<h3 id="unit-testing"><a class="header" href="#unit-testing">Unit Testing</a></h3>
<p>Bind test values directly:</p>
<pre><code class="language-java">@Test
void shouldReadTraceId() {
    Context&lt;String, String&gt; ctx = Context.ask(TRACE_ID);

    String result = ScopedValue
        .where(TRACE_ID, "test-trace-123")
        .call(() -&gt; ctx.run());

    assertThat(result).isEqualTo("test-trace-123");
}
</code></pre>
<h3 id="testing-context-composition"><a class="header" href="#testing-context-composition">Testing Context Composition</a></h3>
<p>When combining contexts with different scoped value types, use <code>toVTask()</code>:</p>
<pre><code class="language-java">@Test
void shouldComposeMultipleContexts() throws Exception {
    // Convert to VTask to combine different ScopedValue types
    VTask&lt;RequestInfo&gt; task =
        Context.ask(TRACE_ID).toVTask().flatMap(traceId -&gt;
            Context.ask(LOCALE).toVTask().map(locale -&gt;
                new RequestInfo(traceId, locale)));

    RequestInfo result = ScopedValue
        .where(TRACE_ID, "test-123")
        .where(LOCALE, Locale.FRANCE)
        .call(() -&gt; task.run());

    assertThat(result.traceId()).isEqualTo("test-123");
    assertThat(result.locale()).isEqualTo(Locale.FRANCE);
}
</code></pre>
<h3 id="testing-unbound-behaviour"><a class="header" href="#testing-unbound-behaviour">Testing Unbound Behaviour</a></h3>
<pre><code class="language-java">@Test
void shouldThrowWhenUnbound() {
    Context&lt;String, String&gt; ctx = Context.ask(TRACE_ID);

    assertThatThrownBy(() -&gt; ctx.run())
        .isInstanceOf(NoSuchElementException.class);
}
</code></pre>
<hr />
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Concept</th><th>Description</th></tr></thead><tbody>
<tr><td><code>ScopedValue&lt;R&gt;</code></td><td>Java 25 API for thread-scoped immutable values</td></tr>
<tr><td><code>Context&lt;R, A&gt;</code></td><td>Effect type for reading scoped values functionally</td></tr>
<tr><td><code>Context.ask(key)</code></td><td>Read a scoped value</td></tr>
<tr><td><code>Context.asks(key, f)</code></td><td>Read and transform in one step</td></tr>
<tr><td><code>map</code>, <code>flatMap</code></td><td>Transform and compose contexts</td></tr>
<tr><td><code>toVTask()</code></td><td>Convert to VTask for execution</td></tr>
<tr><td><code>ScopedValue.where().call()</code></td><td>Bind values and execute</td></tr>
<tr><td>Inheritance</td><td>Child virtual threads inherit bindings</td></tr>
</tbody></table>
</div><div id="admonition-hands-on-learning" class="admonition admonish-info" role="note" aria-labelledby="admonition-hands-on-learning-title">
<div class="admonition-title">
<div id="admonition-hands-on-learning-title">
<p>Hands-On Learning</p>
</div>
<a class="admonition-anchor-link" href="#admonition-hands-on-learning"></a>
</div>
<div>
<p>Practice Context patterns in <a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/test/java/org/higherkindedj/tutorial/context/Tutorial01_ContextFundamentals.java">Tutorial 01: Context Fundamentals</a> (7 exercises, ~25 minutes).</p>
</div>
</div>
<div id="admonition-see-also" class="admonition admonish-tip" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See Also</p>
</div>
<a class="admonition-anchor-link" href="#admonition-see-also"></a>
</div>
<div>
<ul>
<li><a href="../effect/context_request.html">RequestContext Patterns</a> -- Request tracing and metadata</li>
<li><a href="../effect/context_security.html">SecurityContext Patterns</a> -- Authentication and authorisation</li>
<li><a href="../effect/context_vs_config.html">Context vs ConfigContext</a> -- When to use each</li>
<li><a href="vtask_monad.html">VTask</a> -- Virtual thread effect type</li>
<li><a href="vtask_scope.html">Scope</a> -- Structured concurrency</li>
<li><a href="reader_monad.html">Reader</a> -- Explicit environment passing</li>
</ul>
</div>
</div>
<hr />
<p><strong>Previous:</strong> <a href="reader_monad.html">Reader Monad</a>
<strong>Next:</strong> <a href="state_monad.html">State Monad</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../monads/reader_monad.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../monads/state_monad.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../monads/reader_monad.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../monads/state_monad.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../version-switcher.js"></script>
        <script src=".././theme/version-switcher.js"></script>
        <script src=".././theme/sidebar-nav-link.js"></script>


    </div>
    </body>
</html>
