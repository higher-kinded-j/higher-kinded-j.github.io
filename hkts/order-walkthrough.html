<!DOCTYPE HTML>
<html lang="en" class="latte sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>An Order Workflow - Higher-Kinded Types and Optics for Java</title>


        <!-- Custom HTML head -->


            <meta name="description" content="Explore Higher-Kinded Types (HKTs) and Optcs in Java with the Higher-Kinded-J library. Learn about Functors, Applicatives, Monads, Transformers, practical functional patterns, and how to write cleaner, more composable Java code for your projects using Optics.">


        <meta name="keywords" content="Higher-Kinded Types, Higher-Kinded-J, Higher-Kinded Java, Higher Kinded Java, HKT, Java, Optics, Lens, Prism, Traversal, Iso, Functional Programming, Monad, Functor, Applicative, Transformer, Monoid, Traverse, higherkindedj">
        
        <meta property="og:title" content="An Order Workflow - Higher-Kinded Types and Optics for Java"> 
            <meta property="og:description" content="Explore Higher-Kinded Types (HKTs) and Optcs in Java with the Higher-Kinded-J library. Learn about Functors, Applicatives, Monads, Transformers, practical functional patterns, and how to write cleaner, more composable Java code for your projects using Optics.">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://higher-kinded-j.github.io/"> 
        
        <meta property="og:image" content="https://higher-kinded-j.github.io/preview.png" />
        <meta property="og:site_name" content="Higher-Kinded-J Documentation" />
        
        
        <meta name="twitter:card" content="summary_large_image" /> <meta name="twitter:title" content="An Order Workflow - Higher-Kinded Types and Optics for Java - Higher-Kinded-J" />
        <meta name="twitter:description" content="Bringing Higher-Kinded Types and Optics to Java functional patterns" />
        <meta name="twitter:image" content="https://higher-kinded-j.github.io/preview.png" />
        <meta name="description" content="Explore Higher-Kinded Types (HKTs) and Optcs in Java with the Higher-Kinded-J library. Learn about Functors, Applicatives, Monads, Transformers, practical functional patterns, and how to write cleaner, more composable Java code for your projects using Optics.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">
        <meta name="google-site-verification" content="X-xsiAq2cKMLOzh9dexUrX8Onx2h_YMUFgp5lHHUwSg" />
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin.css">
        <link rel="stylesheet" href=".././theme/catppuccin-admonish.css">
        <link rel="stylesheet" href=".././theme/catppuccin-alerts.css">
        <link rel="stylesheet" href=".././theme/additional-hkj.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "latte";
            const default_dark_theme = "macchiato";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('latte')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frapp√©</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Higher-Kinded Types and Optics for Java</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/higher-kinded-j/higher-kinded-j/edit/main/hkj-book/src/hkts/order-walkthrough.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="the-order-workflow-example"><a class="header" href="#the-order-workflow-example">The Order Workflow Example</a></h1>
<p>This example is a practical demonstration of how to use the Higher-Kinded-J library to manage a common real-world scenario.</p>
<p>The scenario covers an Order workflow that involves asynchronous operations.  The Operations can fail with specific, expected business errors.</p>
<h2 id="async-operations-with-error-handling"><a class="header" href="#async-operations-with-error-handling">Async Operations with Error Handling:</a></h2>
<p>You can find the code for the Order Processing example in the <a href="https://github.com/higher-kinded-j/higher-kinded-j/tree/main/hkj-examples/src/main/java/org/higherkindedj/example/order/workflow"><code>org.higherkindedj.example.order</code></a> package.</p>
<p><strong>Goal of this Example:</strong></p>
<ul>
<li>To show how to compose asynchronous steps (using <code>CompletableFuture</code>) with steps that might result in domain-specific errors (using <code>Either</code>).</li>
<li>To introduce the <strong><code>EitherT</code> monad transformer</strong> as a powerful tool to simplify working with nested structures like <code>CompletableFuture&lt;Either&lt;DomainError, Result&gt;&gt;</code>.</li>
<li>To illustrate how to handle different kinds of errors:
<ul>
<li><strong>Domain Errors:</strong> Expected business failures (e.g., invalid input, item out of stock) represented by <code>Either.Left</code>.</li>
<li><strong>System Errors:</strong> Unexpected issues during async execution (e.g., network timeouts) handled by <code>CompletableFuture</code>.</li>
<li><strong>Synchronous Exceptions:</strong> Using <code>Try</code> to capture exceptions from synchronous code and integrate them into the error handling flow.</li>
</ul>
</li>
<li>To demonstrate error recovery using <code>MonadError</code> capabilities.</li>
<li>To show how dependencies (like logging) can be managed within the workflow steps.</li>
</ul>
<p><strong>Prerequisites:</strong></p>
<p>Before diving in, it's helpful to have a basic understanding of:</p>
<ul>
<li><a href="core-concepts.html">Core Concepts</a> of Higher-Kinded-J (<code>Kind</code>and Type Classes).</li>
<li>The specific types being used: <a href="../monads/supported-types.html">Supported Types</a>.</li>
<li>The general <a href="usage-guide.html">Usage Guide</a>.</li>
</ul>
<p><strong>Key Files:</strong></p>
<ul>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/order/workflow/Dependencies.java"><code>Dependencies.java</code></a>: Holds external dependencies (e.g., logger).</li>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/order/workflow/OrderWorkflowRunner.java"><code>OrderWorkflowRunner.java</code></a>: Orchestrates the workflow, initialising and running different workflow versions (Workflow1 and Workflow2).</li>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/order/workflow/OrderWorkflowSteps.java"><code>OrderWorkflowSteps.java</code></a>: Defines the individual workflow steps (sync/async), accepting <code>Dependencies</code>.</li>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/order/workflow/Workflow1.java"><code>Workflow1.java</code></a>: Implements the order processing workflow using <code>EitherT</code> over <code>CompletableFuture</code>, with the initial validation step using an <code>Either</code>.</li>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/order/workflow/Workflow2.java"><code>Workflow2.java</code></a>: Implements a similar workflow to <code>Workflow1</code>, but the initial validation step uses a <code>Try</code> that is then converted to an <code>Either</code>.</li>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/order/model/WorkflowModels.java"><code>WorkflowModels.java</code></a>: Data records (<code>OrderData</code>, <code>ValidatedOrder</code>, etc.).</li>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/order/error/DomainError.java"><code>DomainError.java</code></a>: Sealed interface defining specific business errors.</li>
</ul>
<hr />
<h2 id="order-processing-workflow"><a class="header" href="#order-processing-workflow">Order Processing Workflow</a></h2>
<p><img src="../images/mermaid-flow-transparent.svg" alt="mermaid-flow-transparent.svg" /></p>
<hr />
<h2 id="the-problem-combining-asynchronicity-and-typed-errors"><a class="header" href="#the-problem-combining-asynchronicity-and-typed-errors">The Problem: Combining Asynchronicity and Typed Errors</a></h2>
<p>Imagine an online order process with the following stages:</p>
<ol>
<li><strong>Validate Order Data:</strong> Check quantity, product ID, etc. (Can fail with <code>ValidationError</code>). This is a synchronous operation.</li>
<li><strong>Check Inventory:</strong> Call an external inventory service (async). (Can fail with <code>StockError</code>).</li>
<li><strong>Process Payment:</strong> Call a payment gateway (async). (Can fail with <code>PaymentError</code>).</li>
<li><strong>Create Shipment:</strong> Call a shipping service (async). (Can fail with <code>ShippingError</code>, some of which might be recoverable).</li>
<li><strong>Notify Customer:</strong> Send an email/SMS (async). (Might fail, but should not critically fail the entire order).</li>
</ol>
<p>We face several challenges:</p>
<ul>
<li><strong>Asynchronicity:</strong> Steps 2, 3, 4, 5 involve network calls and should use <code>CompletableFuture</code>.</li>
<li><strong>Domain Errors:</strong> Steps can fail for specific business reasons. We want to represent these failures with <em>types</em> (like <code>ValidationError</code>, <code>StockError</code>) rather than just generic exceptions or nulls. <code>Either&lt;DomainError, SuccessValue&gt;</code> is a good fit for this.</li>
<li><strong>Composition:</strong> How do we chain these steps together? Directly nesting <code>CompletableFuture&lt;Either&lt;DomainError, ...&gt;&gt;</code> leads to complex and hard-to-read code (often called "callback hell" or nested <code>thenCompose</code>/<code>thenApply</code> chains).</li>
<li><strong>Short-Circuiting:</strong> If validation fails (returns <code>Left(ValidationError)</code>), we shouldn't proceed to check inventory or process payment. The workflow should stop and return the validation error.</li>
<li><strong>Dependencies &amp; Logging:</strong> Steps need access to external resources (like service clients, configuration, loggers). How do we manage this cleanly?</li>
</ul>
<h2 id="the-solution-eithert-monad-transformer--dependency-injection"><a class="header" href="#the-solution-eithert-monad-transformer--dependency-injection">The Solution: <code>EitherT</code> Monad Transformer + Dependency Injection</a></h2>
<p>This example tackles these challenges using:</p>
<ol>
<li><strong><code>Either&lt;DomainError, R&gt;</code></strong>: To represent the result of steps that can fail with a specific business error (<code>DomainError</code>). <code>Left</code> holds the error, <code>Right</code> holds the success value <code>R</code>.</li>
<li><strong><code>CompletableFuture&lt;T&gt;</code></strong>: To handle the asynchronous nature of external service calls. It also inherently handles system-level exceptions (network timeouts, service unavailability) by completing exceptionally with a <code>Throwable</code>.</li>
<li><strong><code>EitherT&lt;F_OUTER_WITNESS, L_ERROR, R_VALUE&gt;</code></strong>: The key component! This <em>monad transformer</em> wraps a nested structure <code>Kind&lt;F_OUTER_WITNESS, Either&lt;L_ERROR, R_VALUE&gt;&gt;</code>. In our case:
<ul>
<li><code>F_OUTER_WITNESS</code> (Outer Monad's Witness) = <code>CompletableFutureKind.Witness</code> (handling async and system errors <code>Throwable</code>).</li>
<li><code>L_ERROR</code> (Left Type) = <code>DomainError</code> (handling business errors).</li>
<li><code>R_VALUE</code> (Right Type) = The success value of a step.
It provides <code>map</code>, <code>flatMap</code>, and <code>handleErrorWith</code> operations that work seamlessly across <em>both</em> the outer <code>CompletableFuture</code> context and the inner <code>Either</code> context.</li>
</ul>
</li>
<li><strong>Dependency Injection:</strong> A <code>Dependencies</code> record holds external collaborators (like a logger). This record is passed to <code>OrderWorkflowSteps</code>, making dependencies explicit and testable.</li>
<li><strong>Structured Logging:</strong> Steps use the injected logger (<code>dependencies.log(...)</code>) for consistent logging.</li>
</ol>
<h3 id="setting-up-eithertmonad"><a class="header" href="#setting-up-eithertmonad">Setting up <code>EitherTMonad</code></a></h3>
<p>In <code>OrderWorkflowRunner</code>, we get the necessary type class instances:</p>
<pre><code class="language-java">// MonadError instance for CompletableFuture (handles Throwable)
// F_OUTER_WITNESS for CompletableFuture is CompletableFutureKind.Witness
private final @NonNull MonadError&lt;CompletableFutureKind.Witness, Throwable&gt; futureMonad =
    CompletableFutureMonad.INSTANCE;

// EitherTMonad instance, providing the outer monad (futureMonad).
// This instance handles DomainError for the inner Either.
// The HKT witness for EitherT here is EitherTKind.Witness&lt;CompletableFutureKind.Witness, DomainError&gt;
private final @NonNull
MonadError&lt;EitherTKind.Witness&lt;CompletableFutureKind.Witness, DomainError&gt;, DomainError&gt;
    eitherTMonad = new EitherTMonad&lt;&gt;(this.futureMonad);
</code></pre>
<p>Now, <code>eitherTMonad</code> can be used to chain operations on <code>EitherT</code> values (which are <code>Kind&lt;EitherTKind.Witness&lt;CompletableFutureKind.Witness, DomainError&gt;, A&gt;</code>). Its <code>flatMap</code> method automatically handles:</p>
<ul>
<li><strong>Async Sequencing:</strong> Delegated to <code>futureMonad.flatMap</code> (which translates to <code>CompletableFuture::thenCompose</code>).</li>
<li><strong>Error Short-Circuiting:</strong> If an inner <code>Either</code> becomes <code>Left(domainError)</code>, subsequent <code>flatMap</code> operations are skipped, propagating the <code>Left</code> within the <code>CompletableFuture</code>.</li>
</ul>
<h2 id="workflow-step-by-step-workflow1java"><a class="header" href="#workflow-step-by-step-workflow1java">Workflow Step-by-Step (<code>Workflow1.java</code>)</a></h2>
<ul>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/order/workflow/Workflow1.java">Workflow1.java</a></li>
</ul>
<p>Let's trace the execution flow defined in <code>Workflow1</code>. The workflow uses a <code>For</code> comprehension to sequentially chain the steps. steps. The state (<code>WorkflowContext</code>) is carried implicitly within the <code>Right</code> side of the <code>EitherT</code>.</p>
<p>The <code>OrderWorkflowRunner</code> initialises and calls <code>Workflow1</code> (or <code>Workflow2</code>). The core logic for composing the steps resides within these classes.</p>
<p>We start with <code>OrderData</code> and create an initial <code>WorkflowContext</code>.</p>
<p>Next <code>eitherTMonad.of(initialContext)</code> lifts this context into an <code>EitherT</code> value. This represents a <code>CompletableFuture</code> that is already successfully completed with an <code>Either.Right(initialContext)</code>.We start with OrderData and create an initial WorkflowContext.
eitherTMonad.of(initialContext) lifts this context into an EitherT value. This represents a CompletableFuture that is already successfully completed with an Either.Right(initialContext).</p>
<pre><code class="language-java">// From Workflow1.run()

var initialContext = WorkflowModels.WorkflowContext.start(orderData);

// The For-comprehension expresses the workflow sequentially.
// Each 'from' step represents a monadic bind (flatMap).
var workflow = For.from(eitherTMonad, eitherTMonad.of(initialContext))
    // Step 1: Validation. The lambda receives the initial context.
    .from(ctx1 -&gt; {
      var validatedOrderET = EitherT.fromEither(futureMonad, EITHER.narrow(steps.validateOrder(ctx1.initialData())));
      return eitherTMonad.map(ctx1::withValidatedOrder, validatedOrderET);
    })
    // Step 2: Inventory. The lambda receives a tuple of (initial context, context after validation).
    .from(t -&gt; {
      var ctx = t._2(); // Get the context from the previous step
      var inventoryCheckET = EitherT.fromKind(steps.checkInventoryAsync(ctx.validatedOrder().productId(), ctx.validatedOrder().quantity()));
      return eitherTMonad.map(ignored -&gt; ctx.withInventoryChecked(), inventoryCheckET);
    })
    // Step 3: Payment. The lambda receives a tuple of all previous results. The latest context is the last element.
    .from(t -&gt; {
      var ctx = t._3(); // Get the context from the previous step
      var paymentConfirmET = EitherT.fromKind(steps.processPaymentAsync(ctx.validatedOrder().paymentDetails(), ctx.validatedOrder().amount()));
      return eitherTMonad.map(ctx::withPaymentConfirmation, paymentConfirmET);
    })
    // Step 4: Shipment (with error handling).
    .from(t -&gt; {
        var ctx = t._4(); // Get the context from the previous step
        var shipmentAttemptET = EitherT.fromKind(steps.createShipmentAsync(ctx.validatedOrder().orderId(), ctx.validatedOrder().shippingAddress()));
        var recoveredShipmentET = eitherTMonad.handleErrorWith(shipmentAttemptET, error -&gt; {
            if (error instanceof DomainError.ShippingError(var reason) &amp;&amp; "Temporary Glitch".equals(reason)) {
                dependencies.log("WARN: Recovering from temporary shipping glitch for order " + ctx.validatedOrder().orderId());
                return eitherTMonad.of(new WorkflowModels.ShipmentInfo("DEFAULT_SHIPPING_USED"));
            }
            return eitherTMonad.raiseError(error);
        });
        return eitherTMonad.map(ctx::withShipmentInfo, recoveredShipmentET);
    })
    // Step 5 &amp; 6 are combined in the yield for a cleaner result.
    .yield(t -&gt; {
      var finalContext = t._5(); // The context after the last 'from'
      var finalResult = new WorkflowModels.FinalResult(
          finalContext.validatedOrder().orderId(),
          finalContext.paymentConfirmation().transactionId(),
          finalContext.shipmentInfo().trackingId()
      );

      // Attempt notification, but recover from failure, returning the original FinalResult.
      var notifyET = EitherT.fromKind(steps.notifyCustomerAsync(finalContext.initialData().customerId(), "Order processed: " + finalResult.orderId()));
      var recoveredNotifyET = eitherTMonad.handleError(notifyET, notifyError -&gt; {
        dependencies.log("WARN: Notification failed for order " + finalResult.orderId() + ": " + notifyError.message());
        return Unit.INSTANCE;
      });

      // Map the result of the notification back to the FinalResult we want to return.
      return eitherTMonad.map(ignored -&gt; finalResult, recoveredNotifyET);
    });

// The yield returns a Kind&lt;M, Kind&lt;M, R&gt;&gt;, so we must flatten it one last time.
var flattenedFinalResultET = eitherTMonad.flatMap(x -&gt; x, workflow);

var finalConcreteET = EITHER_T.narrow(flattenedFinalResultET);
return finalConcreteET.value();
</code></pre>
<p>There is a lot going on in the <code>For</code> comprehension so lets try and unpick it.</p>
<h4 id="breakdown-of-the-for-comprehension"><a class="header" href="#breakdown-of-the-for-comprehension">Breakdown of the <code>For</code> Comprehension:</a></h4>
<ol>
<li><strong><code>For.from(eitherTMonad, eitherTMonad.of(initialContext))</code></strong>: The comprehension is initiated with a starting value. We lift the initial <code>WorkflowContext</code> into our <code>EitherT</code> monad, representing a successful, asynchronous starting point: <code>Future&lt;Right(initialContext)&gt;</code>.</li>
<li><strong><code>.from(ctx1 -&gt; ...)</code> (Validation)</strong>:
<ul>
<li><strong>Purpose:</strong> Validates the basic order data.</li>
<li><strong>Sync/Async:</strong> Synchronous. <code>steps.validateOrder</code> returns <code>Kind&lt;EitherKind.Witness&lt;DomainError&gt;, ValidatedOrder&gt;</code>.</li>
<li><strong>HKT Integration:</strong> The <code>Either</code> result is lifted into the <code>EitherT&lt;CompletableFuture, ...&gt;</code> context using <code>EitherT.fromEither(...)</code>. This wraps the immediate <code>Either</code> result in a <em>completed</em><code>CompletableFuture</code>.</li>
<li><strong>Error Handling:</strong> If validation fails, <code>validateOrder</code> returns a <code>Left(ValidationError)</code>. This becomes a <code>Future&lt;Left(ValidationError)&gt;</code>, and the <code>For</code> comprehension automatically short-circuits, skipping all subsequent steps.</li>
</ul>
</li>
<li><strong><code>.from(t -&gt; ...)</code> (Inventory Check)</strong>:
<ul>
<li><strong>Purpose:</strong> Asynchronously checks if the product is in stock.</li>
<li><strong>Sync/Async:</strong> Asynchronous. <code>steps.checkInventoryAsync</code> returns <code>Kind&lt;CompletableFutureKind.Witness, Either&lt;DomainError, Unit&gt;&gt;</code>.</li>
<li><strong>HKT Integration:</strong> The <code>Kind</code> returned by the async step is directly wrapped into <code>EitherT</code> using <code>EitherT.fromKind(...)</code>.</li>
<li><strong>Error Handling:</strong> Propagates <code>Left(StockError)</code> or underlying <code>CompletableFuture</code> failures.</li>
</ul>
</li>
<li><strong><code>.from(t -&gt; ...)</code> (Payment)</strong>:
<ul>
<li><strong>Purpose:</strong> Asynchronously processes the payment.</li>
<li><strong>Sync/Async:</strong> Asynchronous.</li>
<li><strong>HKT Integration &amp; Error Handling:</strong> Works just like the inventory check, propagating <code>Left(PaymentError)</code> or <code>CompletableFuture</code> failures.</li>
</ul>
</li>
<li><strong><code>.from(t -&gt; ...)</code> (Shipment with Recovery)</strong>:
<ul>
<li><strong>Purpose:</strong> Asynchronously creates a shipment.</li>
<li><strong>HKT Integration:</strong> Uses <code>EitherT.fromKind</code> and <code>eitherTMonad.handleErrorWith</code>.</li>
<li><strong>Error Handling &amp; Recovery:</strong> If <code>createShipmentAsync</code> returns a <code>Left(ShippingError("Temporary Glitch"))</code>, the <code>handleErrorWith</code> block catches it and returns a <em>successful</em><code>EitherT</code> with default shipment info, allowing the workflow to proceed. All other errors are propagated.</li>
</ul>
</li>
<li><strong><code>.yield(t -&gt; ...)</code> (Final Result and Notification)</strong>:
<ul>
<li><strong>Purpose:</strong> The final block of the <code>For</code> comprehension. It takes the accumulated results from all previous steps (in a tuple <code>t</code>) and produces the final result of the entire chain.</li>
<li><strong>Logic:</strong>
<ol>
<li>It constructs the <code>FinalResult</code> from the successful <code>WorkflowContext</code>.</li>
<li>It attempts the final, non-critical notification step (<code>notifyCustomerAsync</code>).</li>
<li>Crucially, it uses <code>handleError</code> on the notification result. If notification fails, it logs a warning but recovers to a <code>Right(Unit.INSTANCE)</code>, ensuring the overall workflow remains successful.</li>
<li>It then maps the result of the recovered notification step back to the <code>FinalResult</code>, which becomes the final value of the entire comprehension.</li>
</ol>
</li>
</ul>
</li>
<li><strong>Final <code>flatMap</code> and Unwrapping</strong>:
<ul>
<li>The <code>yield</code> block itself can return a monadic value. To get the final, single-layer result, we do one last <code>flatMap</code> over the <code>For</code> comprehension's result.</li>
<li>Finally, <code>EITHER_T.narrow(...)</code> and <code>.value()</code> are used to extract the underlying <code>Kind&lt;CompletableFutureKind.Witness, Either&lt;...&gt;&gt;</code> from the <code>EitherT</code> record. The <code>main</code> method in <code>OrderWorkflowRunner</code> then uses <code>FUTURE.narrow()</code> and <code>.join()</code> to get the final <code>Either</code> result for printing.</li>
</ul>
</li>
</ol>
<hr />
<h2 id="alternative-handling-exceptions-with-try-workflow2java"><a class="header" href="#alternative-handling-exceptions-with-try-workflow2java">Alternative: Handling Exceptions with <code>Try</code> (<code>Workflow2.java</code>)</a></h2>
<p>The <code>OrderWorkflowRunner</code> also initialises and can run <code>Workflow2</code>. This workflow is identical to Workflow1 except for the first step. It demonstrates how to integrate synchronous code that might throw exceptions.</p>
<ul>
<li><a href="https://github.com/higher-kinded-j/higher-kinded-j/blob/main/hkj-examples/src/main/java/org/higherkindedj/example/order/workflow/Workflow2.java">Workflow2.java</a></li>
</ul>
<pre><code class="language-java">// From Workflow2.run(), inside the first .from(...)
.from(ctx1 -&gt; {
  var tryResult = TRY.narrow(steps.validateOrderWithTry(ctx1.initialData()));
  var eitherResult = tryResult.toEither(
      throwable -&gt; (DomainError) new DomainError.ValidationError(throwable.getMessage()));
  var validatedOrderET = EitherT.fromEither(futureMonad, eitherResult);
  // ... map context ...
})
</code></pre>
<ul>
<li>The <code>steps.validateOrderWithTry</code> method is designed to throw exceptions on validation failure (e.g., <code>IllegalArgumentException</code>).</li>
<li><code>TRY.tryOf(...)</code> in <code>OrderWorkflowSteps</code> wraps this potentially exception-throwing code, returning a <code>Kind&lt;TryKind.Witness, ValidatedOrder&gt;</code>.</li>
<li>In <code>Workflow2</code>, we <code>narrow</code> this to a concrete <code>Try&lt;ValidatedOrder&gt;</code>.</li>
<li>We use <code>tryResult.toEither(...)</code> to convert the <code>Try</code> into an <code>Either&lt;DomainError, ValidatedOrder&gt;</code>:
<ul>
<li>A <code>Try.Success(validatedOrder)</code> becomes <code>Either.right(validatedOrder)</code>.</li>
<li>A <code>Try.Failure(throwable)</code> is mapped to an <code>Either.left(new DomainError.ValidationError(throwable.getMessage()))</code>.</li>
</ul>
</li>
<li>The resulting <code>Either</code> is then lifted into <code>EitherT</code> using <code>EitherT.fromEither</code>, and the rest of the workflow proceeds as before.</li>
</ul>
<p>This demonstrates a practical pattern for integrating synchronous, exception-throwing code into the <code>EitherT</code>-based workflow by explicitly converting failures into your defined <code>DomainError</code> types.</p>
<hr />
<div id="admonition-key-points" class="admonition admonish-tip" role="note" aria-labelledby="admonition-key-points-title">
<div class="admonition-title">
<div id="admonition-key-points-title">
<p>Key Points:</p>
</div>
<a class="admonition-anchor-link" href="#admonition-key-points"></a>
</div>
<div>
<p>This example illustrates several powerful patterns enabled by Higher-Kinded-J:</p>
<ol>
<li><strong><code>EitherT</code> for <code>Future&lt;Either&lt;Error, Value&gt;&gt;</code></strong>: This is the core pattern. Use <code>EitherT</code> whenever you need to sequence asynchronous operations (<code>CompletableFuture</code>) where each step can also fail with a specific, typed error (<code>Either</code>).
<ul>
<li>Instantiate <code>EitherTMonad&lt;F_OUTER_WITNESS, L_ERROR&gt;</code> with the <code>Monad&lt;F_OUTER_WITNESS&gt;</code> instance for your outer monad (e.g., <code>CompletableFutureMonad</code>).</li>
<li>Use <code>eitherTMonad.flatMap</code> or a <code>For</code> comprehension to chain steps.</li>
<li>Lift async results (<code>Kind&lt;F_OUTER_WITNESS, Either&lt;L, R&gt;&gt;</code>) into <code>EitherT</code> using <code>EitherT.fromKind</code>.</li>
<li>Lift sync results (<code>Either&lt;L, R&gt;</code>) into <code>EitherT</code> using <code>EitherT.fromEither</code>.</li>
<li>Lift pure values (<code>R</code>) into <code>EitherT</code> using <code>eitherTMonad.of</code> or <code>EitherT.right</code>.</li>
<li>Lift errors (<code>L</code>) into <code>EitherT</code> using <code>eitherTMonad.raiseError</code> or <code>EitherT.left</code>.</li>
</ul>
</li>
<li><strong>Typed Domain Errors</strong>: Use <code>Either</code> (often with a sealed interface like <code>DomainError</code> for the <code>Left</code> type) to represent expected business failures clearly. This improves type safety and makes error handling more explicit.</li>
<li><strong>Error Recovery</strong>: Use <code>eitherTMonad.handleErrorWith</code> (for complex recovery returning another <code>EitherT</code>) or <code>handleError</code> (for simpler recovery to a pure value for the <code>Right</code> side) to inspect <code>DomainError</code>s and potentially recover, allowing the workflow to continue gracefully.</li>
<li><strong>Integrating <code>Try</code></strong>: If dealing with synchronous legacy code or libraries that throw exceptions, wrap calls using <code>TRY.tryOf</code>. Then, <code>narrow</code> the <code>Try</code> and use <code>toEither</code> (or <code>fold</code>) to convert <code>Try.Failure</code> into an appropriate <code>Either.Left&lt;DomainError&gt;</code> before lifting into <code>EitherT</code>.</li>
<li><strong>Dependency Injection</strong>: Pass necessary dependencies (loggers, service clients, configurations) into your workflow steps (e.g., via a constructor and a <code>Dependencies</code> record). This promotes loose coupling and testability.</li>
<li><strong>Structured Logging</strong>: Use an injected logger within steps to provide visibility into the workflow's progress and state without tying the steps to a specific logging implementation (like <code>System.out</code>).</li>
<li><strong><code>var</code> for Conciseness</strong>: Utilise Java's <code>var</code> for local variable type inference where the type is clear from the right-hand side of an assignment. This can reduce verbosity, especially with complex generic types common in HKT.</li>
</ol>
</div>
</div>
<hr />
<div id="admonition-further-considerations--potential-enhancements" class="admonition admonish-success" role="note" aria-labelledby="admonition-further-considerations--potential-enhancements-title">
<div class="admonition-title">
<div id="admonition-further-considerations--potential-enhancements-title">
<p>Further Considerations &amp; Potential Enhancements</p>
</div>
<a class="admonition-anchor-link" href="#admonition-further-considerations--potential-enhancements"></a>
</div>
<div>
<p>While this example covers a the core concepts, a real-world application might involve more complexities. Here are some areas to consider for further refinement:</p>
<ol>
<li><strong>More Sophisticated Error Handling/Retries:</strong>
<ul>
<li><strong>Retry Mechanisms:</strong> For transient errors (like network hiccups or temporary service unavailability), you might implement retry logic. This could involve retrying a failed async step a certain number of times with exponential backoff. While <code>higher-kinded-j</code> itself doesn't provide specific retry utilities, you could integrate libraries like Resilience4j or implement custom retry logic within a <code>flatMap</code> or <code>handleErrorWith</code> block.</li>
<li><strong>Compensating Actions (Sagas):</strong> If a step fails after previous steps have caused side effects (e.g., payment succeeds, but shipment fails irrevocably), you might need to trigger compensating actions (e.g., refund payment). This often leads to more complex Saga patterns.</li>
</ul>
</li>
<li><strong>Configuration of Services:</strong>
<ul>
<li>The <code>Dependencies</code> record currently only holds a logger. In a real application, it would also provide configured instances of service clients (e.g., <code>InventoryService</code>, <code>PaymentGatewayClient</code>, <code>ShippingServiceClient</code>). These clients would be interfaces, with concrete implementations (real or mock for testing) injected.</li>
</ul>
</li>
<li><strong>Parallel Execution of Independent Steps:</strong>
<ul>
<li>If some workflow steps are independent and can be executed concurrently, you could leverage <code>CompletableFuture.allOf</code> (to await all) or <code>CompletableFuture.thenCombine</code> (to combine results of two).</li>
<li>Integrating these with <code>EitherT</code> would require careful management of the <code>Either</code> results from parallel futures. For instance, if you run two <code>EitherT</code> operations in parallel, you'd get two <code>CompletableFuture&lt;Either&lt;DomainError, ResultX&gt;&gt;</code>. You would then need to combine these, deciding how to aggregate errors if multiple occur, or how to proceed if one fails and others succeed.</li>
</ul>
</li>
<li><strong>Transactionality:</strong>
<ul>
<li>For operations requiring atomicity (all succeed or all fail and roll back), traditional distributed transactions are complex. The Saga pattern mentioned above is a common alternative for managing distributed consistency.</li>
<li>Individual steps might interact with transactional resources (e.g., a database). The workflow itself would coordinate these, but doesn't typically manage a global transaction across disparate async services.</li>
</ul>
</li>
<li><strong>More Detailed &amp; Structured Logging:</strong>
<ul>
<li>The current logging is simple string messages. For better observability, use a structured logging library (e.g., SLF4J with Logback/Log4j2) and log key-value pairs (e.g., <code>orderId</code>, <code>stepName</code>, <code>status</code>, <code>durationMs</code>, <code>errorType</code> if applicable). This makes logs easier to parse, query, and analyse.</li>
<li>Consider logging at the beginning and end of each significant step, including the outcome (success/failure and error details).</li>
</ul>
</li>
<li><strong>Metrics &amp; Monitoring:</strong>
<ul>
<li>Instrument the workflow to emit metrics (e.g., using Micrometer). Track things like workflow execution time, step durations, success/failure counts for each step, and error rates. This is crucial for monitoring the health and performance of the system.</li>
</ul>
</li>
</ol>
</div>
</div>
<p>Higher-Kinded-J can help build more robust, resilient, and observable workflows using these foundational patterns from this example.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../transformers/statet_transformer.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../hkts/draughts.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../transformers/statet_transformer.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../hkts/draughts.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
